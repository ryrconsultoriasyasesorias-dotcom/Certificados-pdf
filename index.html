<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Proteger PDFs con DNI</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #232736;
    --border: #2e3348;
    --text: #e8e9ed;
    --text2: #9096a8;
    --accent: #6c5ce7;
    --accent-glow: rgba(108, 92, 231, 0.25);
    --success: #00b894;
    --error: #e17055;
    --warning: #fdcb6e;
    --radius: 12px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding: 2rem;
    background-image: 
      radial-gradient(ellipse at 20% 0%, rgba(108, 92, 231, 0.08) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 100%, rgba(0, 184, 148, 0.06) 0%, transparent 50%);
  }

  .container { max-width: 820px; margin: 0 auto; }
  header { text-align: center; margin-bottom: 2.5rem; }

  header h1 {
    font-family: 'Space Mono', monospace;
    font-size: 1.8rem; font-weight: 700; letter-spacing: -0.5px; margin-bottom: 0.5rem;
    background: linear-gradient(135deg, #e8e9ed 0%, #6c5ce7 100%);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }

  header p { color: var(--text2); font-size: 0.95rem; max-width: 520px; margin: 0 auto; }

  .steps { display: flex; gap: 1rem; margin-bottom: 2rem; }

  .step-indicator {
    flex: 1; display: flex; align-items: center; gap: 0.6rem;
    padding: 0.8rem 1rem; background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); font-size: 0.85rem; color: var(--text2); transition: all 0.3s;
  }
  .step-indicator.active { border-color: var(--accent); color: var(--text); box-shadow: 0 0 20px var(--accent-glow); }
  .step-indicator.done { border-color: var(--success); color: var(--success); }

  .step-num {
    width: 26px; height: 26px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Space Mono', monospace; font-size: 0.75rem; font-weight: 700;
    background: var(--surface2); flex-shrink: 0;
  }
  .step-indicator.active .step-num { background: var(--accent); color: white; }
  .step-indicator.done .step-num { background: var(--success); color: white; }

  .card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1.2rem; transition: all 0.3s;
  }
  .card:hover { border-color: #3d4260; }
  .card h3 { font-size: 1rem; font-weight: 600; margin-bottom: 0.3rem; }
  .card .desc { font-size: 0.85rem; color: var(--text2); margin-bottom: 1rem; }

  .upload-zone {
    border: 2px dashed var(--border); border-radius: var(--radius);
    padding: 2rem; text-align: center; cursor: pointer; transition: all 0.3s; position: relative;
  }
  .upload-zone:hover, .upload-zone.dragover { border-color: var(--accent); background: rgba(108, 92, 231, 0.05); }
  .upload-zone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
  .upload-zone .icon { font-size: 2rem; margin-bottom: 0.5rem; }
  .upload-zone .label { font-size: 0.9rem; color: var(--text2); }
  .upload-zone .label strong { color: var(--accent); }

  .file-info {
    display: flex; align-items: center; gap: 0.5rem;
    padding: 0.6rem 1rem; background: var(--surface2); border-radius: 8px;
    font-size: 0.85rem; margin-top: 0.8rem; color: var(--success);
    font-family: 'Space Mono', monospace;
  }
  .file-info.info-err { color: var(--error); }
  .file-info.info-warn { color: var(--warning); }
  .file-info.info-accent { color: var(--accent); }

  .column-select { margin-top: 1rem; display: flex; gap: 1rem; flex-wrap: wrap; }
  .column-select label { font-size: 0.85rem; color: var(--text2); display: block; margin-bottom: 0.3rem; }

  .column-select select {
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); padding: 0.5rem 0.8rem; border-radius: 8px;
    font-family: 'DM Sans', sans-serif; font-size: 0.85rem; min-width: 180px; cursor: pointer;
  }
  .column-select select:focus { outline: none; border-color: var(--accent); }

  .match-mode { margin-top: 1rem; }
  .match-mode > label { font-size: 0.85rem; color: var(--text2); display: block; margin-bottom: 0.5rem; }
  .radio-group { display: flex; gap: 0.5rem; flex-wrap: wrap; }

  .radio-option {
    padding: 0.5rem 1rem; background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; font-size: 0.82rem; cursor: pointer; transition: all 0.2s; color: var(--text2);
  }
  .radio-option:hover { border-color: #4a5070; }
  .radio-option.selected { border-color: var(--accent); background: rgba(108, 92, 231, 0.12); color: var(--text); }

  .btn {
    display: inline-flex; align-items: center; gap: 0.5rem;
    padding: 0.9rem 2rem; border: none; border-radius: var(--radius);
    font-family: 'DM Sans', sans-serif; font-size: 0.95rem; font-weight: 600;
    cursor: pointer; transition: all 0.3s; width: 100%; justify-content: center;
  }
  .btn-primary { background: var(--accent); color: white; box-shadow: 0 4px 20px var(--accent-glow); }
  .btn-primary:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 6px 30px rgba(108, 92, 231, 0.4); }
  .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; }

  .btn-secondary {
    background: transparent; color: var(--text2); border: 1px solid var(--border);
    padding: 0.6rem 1.2rem; font-size: 0.85rem; width: auto; margin-top: 0.8rem;
  }
  .btn-secondary:hover { border-color: var(--accent); color: var(--text); }

  .btn-download { background: var(--success); color: white; margin-top: 1rem; }
  .btn-download:hover { transform: translateY(-1px); }

  .progress-area { margin-top: 1.2rem; }
  .progress-bar-bg { height: 6px; background: var(--surface2); border-radius: 3px; overflow: hidden; margin-bottom: 0.8rem; }
  .progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--success)); border-radius: 3px; transition: width 0.3s; }

  .log {
    max-height: 300px; overflow-y: auto;
    font-family: 'Space Mono', monospace; font-size: 0.73rem; line-height: 1.7;
    padding: 1rem; background: var(--bg); border-radius: 8px; border: 1px solid var(--border);
  }
  .log-ok { color: var(--success); }
  .log-err { color: var(--error); }
  .log-warn { color: var(--warning); }
  .log-info { color: var(--text2); }

  .summary { display: flex; gap: 1rem; margin-top: 1rem; margin-bottom: 1rem; }
  .summary-item { flex: 1; text-align: center; padding: 1rem; background: var(--surface2); border-radius: 8px; }
  .summary-item .num { font-family: 'Space Mono', monospace; font-size: 1.5rem; font-weight: 700; }
  .summary-item .lbl { font-size: 0.78rem; color: var(--text2); margin-top: 0.2rem; }

  .preview-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; margin-top: 0.8rem; }
  .preview-table th { text-align: left; padding: 0.5rem 0.8rem; color: var(--text2); font-weight: 500; border-bottom: 1px solid var(--border); }
  .preview-table td { padding: 0.5rem 0.8rem; border-bottom: 1px solid rgba(46, 51, 72, 0.5); font-family: 'Space Mono', monospace; font-size: 0.73rem; }

  .tag { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.72rem; }
  .tag-ok { background: rgba(0, 184, 148, 0.15); color: var(--success); }
  .tag-no { background: rgba(225, 112, 85, 0.15); color: var(--error); }

  .hidden { display: none; }

  .tip {
    display: flex; align-items: flex-start; gap: 0.5rem;
    padding: 0.8rem 1rem; background: rgba(108, 92, 231, 0.08);
    border: 1px solid rgba(108, 92, 231, 0.2);
    border-radius: 8px; font-size: 0.82rem; color: var(--text2); margin-top: 1rem; line-height: 1.5;
  }
  .tip strong { color: var(--accent); }

  .debug-box {
    margin-top: 0.8rem; padding: 0.8rem 1rem; background: var(--bg);
    border: 1px solid var(--border); border-radius: 8px;
    font-family: 'Space Mono', monospace; font-size: 0.72rem; color: var(--text2);
    max-height: 150px; overflow-y: auto; line-height: 1.6;
  }

  .loading-spinner {
    display: inline-block; width: 16px; height: 16px;
    border: 2px solid rgba(255,255,255,0.3); border-top-color: white;
    border-radius: 50%; animation: spin 0.6s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .reset-bar { display: flex; justify-content: flex-end; margin-bottom: 0.5rem; }

  @media (max-width: 600px) {
    body { padding: 1rem; }
    .steps { flex-direction: column; }
    .summary { flex-direction: column; }
    .column-select { flex-direction: column; }
    header h1 { font-size: 1.4rem; }
    .radio-group { flex-direction: column; }
  }

  .log::-webkit-scrollbar, .debug-box::-webkit-scrollbar { width: 4px; }
  .log::-webkit-scrollbar-track, .debug-box::-webkit-scrollbar-track { background: transparent; }
  .log::-webkit-scrollbar-thumb, .debug-box::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>üîê Proteger PDFs con DNI</h1>
    <p>Sube tu Excel con los alumnos y un ZIP con los PDFs. La app lee el contenido de cada PDF para encontrar a qu√© alumno pertenece y le asigna su DNI como contrase√±a.</p>
  </header>

  <div class="reset-bar">
    <button class="btn btn-secondary" onclick="fullReset()">üóëÔ∏è Limpiar todo</button>
  </div>

  <div class="steps">
    <div class="step-indicator active" id="step1-ind"><span class="step-num">1</span> Subir Excel</div>
    <div class="step-indicator" id="step2-ind"><span class="step-num">2</span> Subir PDFs</div>
    <div class="step-indicator" id="step3-ind"><span class="step-num">3</span> Procesar</div>
  </div>

  <!-- STEP 1 -->
  <div class="card">
    <h3>üìä Archivo Excel con alumnos</h3>
    <p class="desc">Debe tener al menos una columna con los nombres y otra con los DNI.</p>
    <div class="upload-zone" id="zone-excel">
      <input type="file" accept=".xlsx,.xls,.csv" id="input-excel" autocomplete="off">
      <div class="icon">üìÑ</div>
      <div class="label">Arrastra tu archivo o <strong>haz clic aqu√≠</strong><br>.xlsx, .xls, .csv</div>
    </div>
    <div id="excel-info" class="hidden"></div>
    <div id="excel-columns" class="hidden">
      <div class="column-select">
        <div>
          <label>Columna con nombre del alumno:</label>
          <select id="col-name"></select>
        </div>
        <div>
          <label>Columna con DNI:</label>
          <select id="col-dni"></select>
        </div>
      </div>
      <div id="preview-container" class="hidden" style="margin-top:1rem;overflow-x:auto;">
        <table class="preview-table" id="preview-table"></table>
      </div>
    </div>
  </div>

  <!-- STEP 2 -->
  <div class="card">
    <h3>üìÅ Archivos PDF de alumnos</h3>
    <p class="desc">Sube un <strong>.zip</strong> con todos los PDFs o selecciona los PDFs sueltos. La app <strong>lee el contenido</strong> de cada PDF para buscar el nombre o DNI del alumno.</p>
    <div class="upload-zone" id="zone-pdfs">
      <input type="file" accept=".pdf,.zip" multiple id="input-pdfs" autocomplete="off">
      <div class="icon">üì¶</div>
      <div class="label">Arrastra tu <strong>.zip</strong> o <strong>selecciona PDFs</strong></div>
    </div>
    <div id="pdfs-loading" class="hidden" style="margin-top:0.8rem;">
      <div class="file-info info-accent"><span class="loading-spinner"></span> <span id="pdfs-loading-text">Extrayendo PDFs del ZIP...</span></div>
    </div>
    <div id="pdfs-info" class="hidden"></div>
    <div id="pdfs-debug" class="hidden"></div>

    <div class="match-mode">
      <label>¬øQu√© buscar dentro de los PDFs?</label>
      <div class="radio-group">
        <div class="radio-option selected" data-value="both" onclick="setMatchMode(this)">
          üß† Nombre y DNI (recomendado)
        </div>
        <div class="radio-option" data-value="dni_only" onclick="setMatchMode(this)">
          Solo DNI
        </div>
        <div class="radio-option" data-value="name_only" onclick="setMatchMode(this)">
          Solo nombre
        </div>
        <div class="radio-option" data-value="filename" onclick="setMatchMode(this)">
          Por nombre de archivo
        </div>
      </div>
    </div>

    <div class="tip">
      üí° <span>La app <strong>lee el texto</strong> dentro de cada PDF y busca el nombre o DNI del alumno. Funciona aunque los archivos se llamen <em>"Lote5_compressed-1.pdf"</em>. Si el PDF es una imagen escaneada (sin texto seleccionable), no podr√° leerlo.</span>
    </div>
  </div>

  <button class="btn btn-primary" id="btn-process" disabled onclick="processAll()">
    üîê Proteger PDFs con contrase√±a
  </button>

  <!-- Results -->
  <div id="results" class="hidden">
    <div class="card" style="margin-top:1.2rem;">
      <h3>üìã Resultado</h3>
      <div class="progress-area">
        <div class="progress-bar-bg"><div class="progress-bar-fill" id="progress-fill" style="width:0%"></div></div>
        <div id="progress-text" style="font-size:0.8rem;color:var(--text2);text-align:center;"></div>
      </div>
      <div class="summary hidden" id="summary">
        <div class="summary-item"><div class="num log-ok" id="count-ok">0</div><div class="lbl">Protegidos</div></div>
        <div class="summary-item"><div class="num log-err" id="count-err">0</div><div class="lbl">Sin coincidencia</div></div>
        <div class="summary-item"><div class="num" style="color:var(--text)" id="count-total">0</div><div class="lbl">Total alumnos</div></div>
      </div>
      <div class="log" id="log"></div>
      <button class="btn btn-download hidden" id="btn-download" onclick="downloadZip()">
        ‚¨áÔ∏è Descargar todos los PDFs protegidos (.zip)
      </button>
    </div>
  </div>
</div>

<script>
  // Configure PDF.js worker
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  let excelData = [];
  let pdfFiles = [];   // {name, data (ArrayBuffer), text (string)}
  let matchMode = 'both';
  let resultZip = null;

  // ============================================
  // FULL RESET
  // ============================================
  function fullReset() {
    excelData = []; pdfFiles = []; matchMode = 'both'; resultZip = null;

    const ei = document.getElementById('input-excel');
    const pi = document.getElementById('input-pdfs');
    ei.value = ''; pi.value = '';
    const ne = ei.cloneNode(true); const np = pi.cloneNode(true);
    ei.parentNode.replaceChild(ne, ei); pi.parentNode.replaceChild(np, pi);
    ne.addEventListener('change', handleExcelUpload);
    np.addEventListener('change', handlePdfsUpload);

    ['excel-info','excel-columns','preview-container','pdfs-info','pdfs-loading','pdfs-debug','results','summary','btn-download']
      .forEach(id => { const el = document.getElementById(id); el.classList.add('hidden'); });
    
    document.getElementById('log').innerHTML = '';
    document.getElementById('progress-fill').style.width = '0%';
    document.getElementById('progress-text').textContent = '';
    document.getElementById('btn-process').disabled = true;
    document.getElementById('btn-process').innerHTML = 'üîê Proteger PDFs con contrase√±a';

    ['step1-ind','step2-ind','step3-ind'].forEach(id => {
      document.getElementById(id).classList.remove('active','done');
    });
    document.getElementById('step1-ind').classList.add('active');

    document.querySelectorAll('.radio-option').forEach(o => o.classList.remove('selected'));
    document.querySelector('[data-value="both"]').classList.add('selected');
  }

  window.addEventListener('DOMContentLoaded', fullReset);
  window.addEventListener('pageshow', e => { if (e.persisted) fullReset(); });

  // Drag-drop visual
  ['zone-excel','zone-pdfs'].forEach(id => {
    const z = document.getElementById(id);
    z.addEventListener('dragover', e => { e.preventDefault(); z.classList.add('dragover'); });
    z.addEventListener('dragleave', () => z.classList.remove('dragover'));
    z.addEventListener('drop', () => z.classList.remove('dragover'));
  });

  function setMatchMode(el) {
    document.querySelectorAll('.radio-option').forEach(o => o.classList.remove('selected'));
    el.classList.add('selected');
    matchMode = el.dataset.value;
  }

  // ============================================
  // TEXT HELPERS
  // ============================================
  function normalize(str) {
    return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase()
      .replace(/[_\-.,;:()[\]{}'"/\\]/g, ' ').replace(/\s+/g, ' ').trim();
  }

  function getWords(str) {
    return normalize(str).split(' ').filter(w => w.length > 1);
  }

  // ============================================
  // EXTRACT TEXT FROM PDF using PDF.js
  // ============================================
  async function extractPdfText(arrayBuffer) {
    try {
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let fullText = '';
      // Read first 3 pages max (for speed)
      const maxPages = Math.min(pdf.numPages, 3);
      for (let i = 1; i <= maxPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const pageText = content.items.map(item => item.str).join(' ');
        fullText += pageText + ' ';
      }
      return fullText;
    } catch (e) {
      console.warn('Error extracting text:', e);
      return '';
    }
  }

  // ============================================
  // MATCHING LOGIC
  // ============================================
  function findPdfMatchByContent(name, dni, pdfTexts) {
    const normName = normalize(name);
    const normDni = normalize(String(dni)).replace(/\s/g, '');
    const nameWords = getWords(name);

    if (matchMode === 'filename') {
      // Old filename-based matching
      for (const pdf of pdfFiles) {
        const pdfBase = normalize(pdf.name.replace(/\.pdf$/i, ''));
        const score = filenameMatch(nameWords, pdfBase, normDni);
        if (score >= 0.7) return pdf;
      }
      return null;
    }

    let bestMatch = null;
    let bestScore = 0;

    for (let idx = 0; idx < pdfFiles.length; idx++) {
      const pdf = pdfFiles[idx];
      const text = normalize(pdfTexts[idx] || '');
      let score = 0;

      // Check DNI match (very strong signal)
      if ((matchMode === 'both' || matchMode === 'dni_only') && normDni.length >= 6) {
        const dniClean = normDni.replace(/[^0-9a-z]/g, '');
        if (dniClean && text.replace(/\s/g, '').includes(dniClean)) {
          score = 1.0; // Perfect match
        }
      }

      // Check name match
      if (score < 1.0 && (matchMode === 'both' || matchMode === 'name_only') && nameWords.length > 0) {
        let wordHits = 0;
        for (const w of nameWords) {
          if (text.includes(w)) wordHits++;
        }
        const nameScore = wordHits / nameWords.length;
        if (nameScore > score) score = nameScore;
      }

      if (score > bestScore) {
        bestScore = score;
        bestMatch = pdf;
      }
    }

    // For DNI match, require exact match (score 1.0)
    // For name match, require at least 70% of words
    if (matchMode === 'dni_only') {
      return bestScore >= 1.0 ? bestMatch : null;
    }
    return bestScore >= 0.7 ? bestMatch : null;
  }

  function filenameMatch(nameWords, pdfBase, normDni) {
    const pdfWords = new Set(pdfBase.split(' ').filter(w => w.length > 1));
    if (normDni && normDni.length >= 6 && pdfBase.includes(normDni)) return 1.0;
    if (nameWords.length === 0) return 0;
    let hits = 0;
    for (const w of nameWords) {
      if (pdfWords.has(w)) hits++;
      else for (const pw of pdfWords) { if (pw.includes(w) || w.includes(pw)) { hits += 0.6; break; } }
    }
    return hits / nameWords.length;
  }

  // ============================================
  // EXCEL UPLOAD
  // ============================================
  async function handleExcelUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    excelData = [];

    const data = await file.arrayBuffer();
    const wb = XLSX.read(data);
    const ws = wb.Sheets[wb.SheetNames[0]];
    excelData = XLSX.utils.sheet_to_json(ws, { defval: '' });

    if (excelData.length === 0) { alert('El archivo Excel est√° vac√≠o.'); return; }

    document.getElementById('excel-info').innerHTML = `<div class="file-info">‚úÖ ${file.name} ‚Äî ${excelData.length} alumnos</div>`;
    document.getElementById('excel-info').classList.remove('hidden');

    const cols = Object.keys(excelData[0]);
    const cn = document.getElementById('col-name');
    const cd = document.getElementById('col-dni');
    cn.innerHTML = ''; cd.innerHTML = '';
    cols.forEach(c => { cn.innerHTML += `<option value="${c}">${c}</option>`; cd.innerHTML += `<option value="${c}">${c}</option>`; });

    const nl = cols.find(c => /nombre|alumno|estudiante|name|apellido/i.test(c));
    const dl = cols.find(c => /dni|documento|cedula|ci|rut|nif|carnet|c√≥digo|codigo/i.test(c));
    if (nl) cn.value = nl;
    if (dl) cd.value = dl;
    cn.onchange = updatePreview; cd.onchange = updatePreview;

    document.getElementById('excel-columns').classList.remove('hidden');
    document.getElementById('step1-ind').classList.remove('active');
    document.getElementById('step1-ind').classList.add('done');
    document.getElementById('step2-ind').classList.add('active');
    updatePreview();
    checkReady();
  }
  document.getElementById('input-excel').addEventListener('change', handleExcelUpload);

  // ============================================
  // PDF HELPERS
  // ============================================
  function isPdfFile(name) { return name.toLowerCase().trim().endsWith('.pdf'); }

  function isHiddenFile(name) {
    return name.split('/').some(p => p.startsWith('.') || p.startsWith('__MACOSX') || p === 'Thumbs.db');
  }

  // ============================================
  // PDF / ZIP UPLOAD
  // ============================================
  async function handlePdfsUpload(e) {
    const files = Array.from(e.target.files);
    if (files.length === 0) return;
    pdfFiles = [];

    const loadingEl = document.getElementById('pdfs-loading');
    const loadingText = document.getElementById('pdfs-loading-text');
    const infoEl = document.getElementById('pdfs-info');
    const debugEl = document.getElementById('pdfs-debug');

    const zipFile = files.find(f => f.name.toLowerCase().endsWith('.zip'));

    if (zipFile) {
      loadingEl.classList.remove('hidden');
      loadingText.textContent = 'Extrayendo PDFs del ZIP...';
      infoEl.classList.add('hidden');
      debugEl.classList.add('hidden');

      try {
        const zipData = await zipFile.arrayBuffer();
        const zip = await JSZip.loadAsync(zipData);
        let debugInfo = `üì¶ "${zipFile.name}" (${(zipFile.size/1024).toFixed(0)} KB)\n`;

        for (const [path, entry] of Object.entries(zip.files)) {
          if (entry.dir || isHiddenFile(path)) continue;
          if (isPdfFile(path)) {
            const data = await entry.async('arraybuffer');
            if (data.byteLength > 0) {
              const fileName = path.split('/').pop();
              pdfFiles.push({ name: fileName, data });
              debugInfo += `‚úì ${fileName} (${(data.byteLength/1024).toFixed(0)} KB)\n`;
            }
          }
        }

        loadingEl.classList.add('hidden');
        infoEl.innerHTML = pdfFiles.length > 0
          ? `<div class="file-info">‚úÖ ${pdfFiles.length} PDFs extra√≠dos del ZIP</div>`
          : `<div class="file-info info-err">‚ùå No se encontraron .pdf dentro del ZIP</div>`;
        infoEl.classList.remove('hidden');
        debugEl.innerHTML = `<div class="debug-box">${debugInfo.replace(/\n/g,'<br>')}</div>`;
        debugEl.classList.remove('hidden');
      } catch (err) {
        loadingEl.classList.add('hidden');
        infoEl.innerHTML = `<div class="file-info info-err">‚ùå Error: ${err.message}</div>`;
        infoEl.classList.remove('hidden');
        return;
      }
    } else {
      loadingEl.classList.remove('hidden');
      loadingText.textContent = 'Cargando PDFs...';
      infoEl.classList.add('hidden');

      for (const file of files) {
        if (isPdfFile(file.name)) {
          const data = await file.arrayBuffer();
          pdfFiles.push({ name: file.name, data });
        }
      }
      loadingEl.classList.add('hidden');
      infoEl.innerHTML = pdfFiles.length > 0
        ? `<div class="file-info">‚úÖ ${pdfFiles.length} PDFs cargados</div>`
        : `<div class="file-info info-err">‚ùå Ning√∫n PDF v√°lido</div>`;
      infoEl.classList.remove('hidden');
    }

    if (pdfFiles.length > 0) {
      document.getElementById('step2-ind').classList.remove('active');
      document.getElementById('step2-ind').classList.add('done');
      document.getElementById('step3-ind').classList.add('active');
    }
    updatePreview();
    checkReady();
  }
  document.getElementById('input-pdfs').addEventListener('change', handlePdfsUpload);

  function updatePreview() {
    if (!excelData.length) return;
    const nameCol = document.getElementById('col-name').value;
    const dniCol = document.getElementById('col-dni').value;
    const table = document.getElementById('preview-table');

    const preview = excelData.slice(0, 5);
    let html = '<thead><tr><th>Nombre</th><th>DNI</th><th>Estado</th></tr></thead><tbody>';
    preview.forEach(row => {
      const name = String(row[nameCol]||'').trim();
      const dni = String(row[dniCol]||'').trim();
      const info = pdfFiles.length > 0
        ? `<span class="tag" style="color:var(--accent)">üìñ se buscar√° en contenido</span>`
        : '<span class="tag" style="color:var(--text2)">‚Äî sube los PDFs</span>';
      html += `<tr><td>${name}</td><td>${dni}</td><td>${info}</td></tr>`;
    });
    if (excelData.length > 5) html += `<tr><td colspan="3" style="color:var(--text2);text-align:center;font-family:'DM Sans'">... y ${excelData.length-5} m√°s</td></tr>`;
    html += '</tbody>';
    table.innerHTML = html;
    document.getElementById('preview-container').classList.remove('hidden');
  }

  function checkReady() {
    document.getElementById('btn-process').disabled = !(excelData.length > 0 && pdfFiles.length > 0);
  }

  // ============================================
  // PROCESS
  // ============================================
  async function processAll() {
    const nameCol = document.getElementById('col-name').value;
    const dniCol = document.getElementById('col-dni').value;
    const log = document.getElementById('log');
    const results = document.getElementById('results');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    const summary = document.getElementById('summary');
    const btnDl = document.getElementById('btn-download');
    const btnProc = document.getElementById('btn-process');

    results.classList.remove('hidden');
    summary.classList.add('hidden');
    btnDl.classList.add('hidden');
    log.innerHTML = '';
    progressFill.style.width = '0%';
    progressText.textContent = '';
    btnProc.disabled = true;
    btnProc.innerHTML = '<span class="loading-spinner"></span> Procesando...';

    resultZip = new JSZip();
    let okCount = 0, errCount = 0;
    const total = excelData.length;
    const usedPdfIndices = new Set();

    // ---- PHASE 1: Extract text from all PDFs ----
    logMsg('info', `üìñ Fase 1: Leyendo texto de ${pdfFiles.length} PDFs...`);
    const pdfTexts = [];

    for (let i = 0; i < pdfFiles.length; i++) {
      progressText.textContent = `Leyendo PDF ${i+1} de ${pdfFiles.length}...`;
      progressFill.style.width = Math.round(((i+1)/pdfFiles.length)*40) + '%';

      const text = await extractPdfText(pdfFiles[i].data);
      pdfTexts.push(text);

      const preview = text.substring(0, 80).replace(/\s+/g, ' ').trim();
      if (text.length > 0) {
        logMsg('info', `  üìÑ ${pdfFiles[i].name}: "${preview}..."`);
      } else {
        logMsg('warn', `  ‚ö† ${pdfFiles[i].name}: sin texto extra√≠ble (¬øimagen/escaneado?)`);
      }

      if (i % 2 === 0) await new Promise(r => setTimeout(r, 10));
    }

    logMsg('info', '');
    logMsg('info', `üîç Fase 2: Buscando coincidencias para ${total} alumnos...`);
    logMsg('info', '');

    // ---- PHASE 2: Match each student ----
    for (let i = 0; i < total; i++) {
      const row = excelData[i];
      const name = String(row[nameCol]||'').trim();
      const dni = String(row[dniCol]||'').trim();

      progressText.textContent = `Procesando alumno ${i+1} de ${total}...`;
      progressFill.style.width = (40 + Math.round(((i+1)/total)*60)) + '%';

      if (!name || !dni) {
        logMsg('warn', `‚ö† Fila ${i+1}: datos vac√≠os`);
        errCount++;
        continue;
      }

      // Find match
      let matchedPdf = null;
      let matchedIdx = -1;

      if (matchMode === 'filename') {
        // Filename-based
        const nameWords = getWords(name);
        const normDni = normalize(dni).replace(/\s/g,'');
        for (let j = 0; j < pdfFiles.length; j++) {
          if (usedPdfIndices.has(j)) continue;
          const pdfBase = normalize(pdfFiles[j].name.replace(/\.pdf$/i,''));
          if (filenameMatch(nameWords, pdfBase, normDni) >= 0.7) {
            matchedPdf = pdfFiles[j]; matchedIdx = j; break;
          }
        }
      } else {
        // Content-based
        const normDni = normalize(dni).replace(/[^0-9a-z]/g,'');
        const nameWords = getWords(name);
        let bestScore = 0;

        for (let j = 0; j < pdfFiles.length; j++) {
          if (usedPdfIndices.has(j)) continue;
          const text = normalize(pdfTexts[j] || '');
          let score = 0;

          // DNI match
          if ((matchMode === 'both' || matchMode === 'dni_only') && normDni.length >= 6) {
            if (text.replace(/\s/g,'').includes(normDni)) {
              score = 1.0;
            }
          }

          // Name match
          if (score < 1.0 && (matchMode === 'both' || matchMode === 'name_only') && nameWords.length > 0) {
            let hits = 0;
            for (const w of nameWords) {
              if (text.includes(w)) hits++;
            }
            const ns = hits / nameWords.length;
            if (ns > score) score = ns;
          }

          if (score > bestScore) {
            bestScore = score;
            matchedPdf = pdfFiles[j];
            matchedIdx = j;
          }
        }

        // Apply threshold
        if (matchMode === 'dni_only' && bestScore < 1.0) { matchedPdf = null; matchedIdx = -1; }
        else if (bestScore < 0.7) { matchedPdf = null; matchedIdx = -1; }
      }

      if (!matchedPdf) {
        logMsg('err', `‚úó ${name} (${dni}) ‚Äî no se encontr√≥ en ning√∫n PDF`);
        errCount++;
      } else {
        try {
          const pdfDoc = await PDFLib.PDFDocument.load(matchedPdf.data, { ignoreEncryption: true });
          const encrypted = await PDFLib.PDFDocument.create();
          const pages = await encrypted.copyPages(pdfDoc, pdfDoc.getPageIndices());
          pages.forEach(p => encrypted.addPage(p));

          const savedBytes = await encrypted.save({
            userPassword: dni, ownerPassword: dni,
            permissions: { printing: 'highQuality', modifying: false, copying: false }
          });

          // Save with student name for easy identification
          const safeName = name.replace(/[/\\?%*:|"<>]/g, '-').trim();
          const outputName = `${safeName}.pdf`;
          resultZip.file(outputName, savedBytes);
          usedPdfIndices.add(matchedIdx);
          logMsg('ok', `‚úì ${name} ‚Üí ${matchedPdf.name} ‚Üí ${outputName} (üîë ${dni})`);
          okCount++;
        } catch (err) {
          logMsg('err', `‚úó ${name} ‚Äî error: ${err.message}`);
          errCount++;
        }
      }

      if (i % 3 === 0) await new Promise(r => setTimeout(r, 5));
    }

    // Unmatched PDFs
    const unmatchedPdfs = pdfFiles.filter((f, i) => !usedPdfIndices.has(i));
    if (unmatchedPdfs.length > 0) {
      logMsg('info', '');
      logMsg('warn', `‚ö† ${unmatchedPdfs.length} PDFs sin asignar:`);
      unmatchedPdfs.forEach(f => logMsg('warn', `   üìÑ ${f.name}`));
    }

    logMsg('info', '');
    logMsg('info', `‚îÅ‚îÅ‚îÅ Completado: ${okCount} protegidos, ${errCount} sin coincidir ‚îÅ‚îÅ‚îÅ`);

    document.getElementById('count-ok').textContent = okCount;
    document.getElementById('count-err').textContent = errCount;
    document.getElementById('count-total').textContent = total;
    summary.classList.remove('hidden');

    if (okCount > 0) btnDl.classList.remove('hidden');

    btnProc.disabled = false;
    btnProc.innerHTML = 'üîê Proteger PDFs con contrase√±a';
    document.getElementById('step3-ind').classList.remove('active');
    document.getElementById('step3-ind').classList.add('done');
    results.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  function logMsg(type, msg) {
    const log = document.getElementById('log');
    log.innerHTML += `<div class="log-${type}">${msg}</div>`;
    log.scrollTop = log.scrollHeight;
  }

  async function downloadZip() {
    const btn = document.getElementById('btn-download');
    btn.innerHTML = '<span class="loading-spinner"></span> Generando ZIP...';
    btn.disabled = true;
    try {
      const blob = await resultZip.generateAsync({ type: 'blob' });
      saveAs(blob, 'PDFs_protegidos.zip');
    } catch (err) { alert('Error: ' + err.message); }
    btn.innerHTML = '‚¨áÔ∏è Descargar todos los PDFs protegidos (.zip)';
    btn.disabled = false;
  }
</script>

</body>
</html>
