<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Proteger PDFs con DNI</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0f1117;--surface:#1a1d27;--surface2:#232736;--border:#2e3348;--text:#e8e9ed;--text2:#9096a8;--accent:#6c5ce7;--accent-glow:rgba(108,92,231,0.25);--success:#00b894;--error:#e17055;--warning:#fdcb6e;--radius:12px}
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:2rem;background-image:radial-gradient(ellipse at 20% 0%,rgba(108,92,231,0.08) 0%,transparent 50%),radial-gradient(ellipse at 80% 100%,rgba(0,184,148,0.06) 0%,transparent 50%)}
  .container{max-width:820px;margin:0 auto}
  header{text-align:center;margin-bottom:2.5rem}
  header h1{font-family:'Space Mono',monospace;font-size:1.8rem;font-weight:700;margin-bottom:0.5rem;background:linear-gradient(135deg,#e8e9ed,#6c5ce7);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  header p{color:var(--text2);font-size:0.95rem;max-width:520px;margin:0 auto}
  .steps{display:flex;gap:1rem;margin-bottom:2rem}
  .si{flex:1;display:flex;align-items:center;gap:0.6rem;padding:0.8rem 1rem;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);font-size:0.85rem;color:var(--text2);transition:all 0.3s}
  .si.active{border-color:var(--accent);color:var(--text);box-shadow:0 0 20px var(--accent-glow)}
  .si.done{border-color:var(--success);color:var(--success)}
  .sn{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Space Mono',monospace;font-size:0.75rem;font-weight:700;background:var(--surface2);flex-shrink:0}
  .si.active .sn{background:var(--accent);color:white}
  .si.done .sn{background:var(--success);color:white}
  .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem;margin-bottom:1.2rem}
  .card h3{font-size:1rem;font-weight:600;margin-bottom:0.3rem}
  .card .desc{font-size:0.85rem;color:var(--text2);margin-bottom:1rem}
  .uz{border:2px dashed var(--border);border-radius:var(--radius);padding:2rem;text-align:center;cursor:pointer;transition:all 0.3s;position:relative}
  .uz:hover,.uz.dragover{border-color:var(--accent);background:rgba(108,92,231,0.05)}
  .uz input{position:absolute;inset:0;opacity:0;cursor:pointer}
  .uz .icon{font-size:2rem;margin-bottom:0.5rem}
  .uz .label{font-size:0.9rem;color:var(--text2)}
  .uz .label strong{color:var(--accent)}
  .fi{display:flex;align-items:center;gap:0.5rem;padding:0.6rem 1rem;background:var(--surface2);border-radius:8px;font-size:0.85rem;margin-top:0.8rem;color:var(--success);font-family:'Space Mono',monospace}
  .fi.fe{color:var(--error)}.fi.fw{color:var(--warning)}.fi.fa{color:var(--accent)}
  .cs{margin-top:1rem;display:flex;gap:1rem;flex-wrap:wrap}
  .cs label{font-size:0.85rem;color:var(--text2);display:block;margin-bottom:0.3rem}
  .cs select{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:0.5rem 0.8rem;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.85rem;min-width:180px;cursor:pointer}
  .cs select:focus{outline:none;border-color:var(--accent)}
  .mm{margin-top:1rem}
  .mm>label{font-size:0.85rem;color:var(--text2);display:block;margin-bottom:0.5rem}
  .rg{display:flex;gap:0.5rem;flex-wrap:wrap}
  .ro{padding:0.5rem 1rem;background:var(--surface2);border:1px solid var(--border);border-radius:8px;font-size:0.82rem;cursor:pointer;transition:all 0.2s;color:var(--text2)}
  .ro:hover{border-color:#4a5070}
  .ro.sel{border-color:var(--accent);background:rgba(108,92,231,0.12);color:var(--text)}
  .btn{display:inline-flex;align-items:center;gap:0.5rem;padding:0.9rem 2rem;border:none;border-radius:var(--radius);font-family:'DM Sans',sans-serif;font-size:0.95rem;font-weight:600;cursor:pointer;transition:all 0.3s;width:100%;justify-content:center}
  .bp{background:var(--accent);color:white;box-shadow:0 4px 20px var(--accent-glow)}
  .bp:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 6px 30px rgba(108,92,231,0.4)}
  .bp:disabled{opacity:0.4;cursor:not-allowed}
  .bs{background:transparent;color:var(--text2);border:1px solid var(--border);padding:0.6rem 1.2rem;font-size:0.85rem;width:auto}
  .bs:hover{border-color:var(--accent);color:var(--text)}
  .bd{background:var(--success);color:white;margin-top:1rem}
  .bd:hover{transform:translateY(-1px)}
  .pa{margin-top:1.2rem}
  .pbb{height:6px;background:var(--surface2);border-radius:3px;overflow:hidden;margin-bottom:0.8rem}
  .pbf{height:100%;background:linear-gradient(90deg,var(--accent),var(--success));border-radius:3px;transition:width 0.3s}
  .log{max-height:300px;overflow-y:auto;font-family:'Space Mono',monospace;font-size:0.73rem;line-height:1.7;padding:1rem;background:var(--bg);border-radius:8px;border:1px solid var(--border)}
  .log-ok{color:var(--success)}.log-err{color:var(--error)}.log-warn{color:var(--warning)}.log-info{color:var(--text2)}
  .sum{display:flex;gap:1rem;margin-top:1rem;margin-bottom:1rem}
  .sui{flex:1;text-align:center;padding:1rem;background:var(--surface2);border-radius:8px}
  .sui .num{font-family:'Space Mono',monospace;font-size:1.5rem;font-weight:700}
  .sui .lbl{font-size:0.78rem;color:var(--text2);margin-top:0.2rem}
  .pt{width:100%;border-collapse:collapse;font-size:0.82rem;margin-top:0.8rem}
  .pt th{text-align:left;padding:0.5rem 0.8rem;color:var(--text2);font-weight:500;border-bottom:1px solid var(--border)}
  .pt td{padding:0.5rem 0.8rem;border-bottom:1px solid rgba(46,51,72,0.5);font-family:'Space Mono',monospace;font-size:0.73rem}
  .hidden{display:none}
  .tip{display:flex;align-items:flex-start;gap:0.5rem;padding:0.8rem 1rem;background:rgba(108,92,231,0.08);border:1px solid rgba(108,92,231,0.2);border-radius:8px;font-size:0.82rem;color:var(--text2);margin-top:1rem;line-height:1.5}
  .tip strong{color:var(--accent)}
  .db{margin-top:0.8rem;padding:0.8rem 1rem;background:var(--bg);border:1px solid var(--border);border-radius:8px;font-family:'Space Mono',monospace;font-size:0.72rem;color:var(--text2);max-height:150px;overflow-y:auto;line-height:1.6}
  .sp{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin 0.6s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .rb{display:flex;justify-content:flex-end;margin-bottom:0.5rem}
  @media(max-width:600px){body{padding:1rem}.steps{flex-direction:column}.sum{flex-direction:column}.cs{flex-direction:column}header h1{font-size:1.4rem}.rg{flex-direction:column}}
  .log::-webkit-scrollbar,.db::-webkit-scrollbar{width:4px}
  .log::-webkit-scrollbar-track,.db::-webkit-scrollbar-track{background:transparent}
  .log::-webkit-scrollbar-thumb,.db::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>üîê Proteger PDFs con DNI</h1>
    <p>Sube tu Excel y un ZIP con los PDFs. La app lee cada PDF, identifica al alumno y lo protege con su DNI como contrase√±a.</p>
  </header>
  <div class="rb"><button class="btn bs" onclick="fullReset()">üóëÔ∏è Limpiar todo</button></div>
  <div class="steps">
    <div class="si active" id="s1"><span class="sn">1</span> Subir Excel</div>
    <div class="si" id="s2"><span class="sn">2</span> Subir PDFs</div>
    <div class="si" id="s3"><span class="sn">3</span> Procesar</div>
  </div>

  <div class="card">
    <h3>üìä Archivo Excel con alumnos</h3>
    <p class="desc">Columna con nombres y otra con DNI.</p>
    <div class="uz" id="ze"><input type="file" accept=".xlsx,.xls,.csv" id="ie" autocomplete="off"><div class="icon">üìÑ</div><div class="label">Arrastra o <strong>haz clic</strong> ‚Äî .xlsx .xls .csv</div></div>
    <div id="ei" class="hidden"></div>
    <div id="ec" class="hidden">
      <div class="cs">
        <div><label>Columna nombre:</label><select id="cn"></select></div>
        <div><label>Columna DNI:</label><select id="cd"></select></div>
      </div>
      <div id="pc" class="hidden" style="margin-top:1rem;overflow-x:auto"><table class="pt" id="ptb"></table></div>
    </div>
  </div>

  <div class="card">
    <h3>üìÅ Archivos PDF</h3>
    <p class="desc">Sube <strong>.zip</strong> o PDFs sueltos. Lee el <strong>contenido</strong> para identificar alumnos.</p>
    <div class="uz" id="zp"><input type="file" accept=".pdf,.zip" multiple id="ip" autocomplete="off"><div class="icon">üì¶</div><div class="label">Arrastra <strong>.zip</strong> o <strong>PDFs</strong></div></div>
    <div id="pl" class="hidden" style="margin-top:0.8rem"><div class="fi fa"><span class="sp"></span> <span id="plt">Extrayendo...</span></div></div>
    <div id="pi" class="hidden"></div>
    <div id="pd" class="hidden"></div>
    <div class="mm">
      <label>¬øQu√© buscar dentro de los PDFs?</label>
      <div class="rg">
        <div class="ro sel" data-value="both" onclick="setM(this)">üß† Nombre y DNI</div>
        <div class="ro" data-value="dni_only" onclick="setM(this)">Solo DNI</div>
        <div class="ro" data-value="name_only" onclick="setM(this)">Solo nombre</div>
        <div class="ro" data-value="filename" onclick="setM(this)">Por archivo</div>
      </div>
    </div>
    <div class="tip">üí° <span>Lee el texto de cada PDF buscando nombre/DNI. El PDF original se mantiene <strong>intacto</strong> (sin convertir a imagen). Solo se le a√±ade contrase√±a.</span></div>
  </div>

  <button class="btn bp" id="bp" disabled onclick="processAll()">üîê Proteger PDFs con contrase√±a</button>

  <div id="res" class="hidden">
    <div class="card" style="margin-top:1.2rem">
      <h3>üìã Resultado</h3>
      <div class="pa">
        <div class="pbb"><div class="pbf" id="pf" style="width:0%"></div></div>
        <div id="pt2" style="font-size:0.8rem;color:var(--text2);text-align:center"></div>
      </div>
      <div class="sum hidden" id="sm">
        <div class="sui"><div class="num log-ok" id="co">0</div><div class="lbl">Protegidos</div></div>
        <div class="sui"><div class="num log-err" id="ce">0</div><div class="lbl">Sin coincidencia</div></div>
        <div class="sui"><div class="num" style="color:var(--text)" id="ct">0</div><div class="lbl">Total</div></div>
      </div>
      <div class="log" id="lg"></div>
      <div id="testArea" class="hidden" style="margin-top:1rem">
        <div class="fi fa">üß™ Verificando encriptaci√≥n del primer PDF...</div>
      </div>
      <button class="btn bd hidden" id="bd" onclick="downloadZip()">‚¨áÔ∏è Descargar PDFs protegidos (.zip)</button>
    </div>
  </div>
</div>

<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  let excelData=[],pdfFiles=[],matchMode='both',resultZip=null;

  function fullReset(){
    excelData=[];pdfFiles=[];matchMode='both';resultZip=null;
    const a=document.getElementById('ie'),b=document.getElementById('ip');
    a.value='';b.value='';
    const na=a.cloneNode(true),nb=b.cloneNode(true);
    a.parentNode.replaceChild(na,a);b.parentNode.replaceChild(nb,b);
    na.addEventListener('change',handleExcel);nb.addEventListener('change',handlePdfs);
    ['ei','ec','pc','pi','pl','pd','res','sm','bd','testArea'].forEach(id=>document.getElementById(id).classList.add('hidden'));
    document.getElementById('lg').innerHTML='';
    document.getElementById('pf').style.width='0%';
    document.getElementById('pt2').textContent='';
    document.getElementById('bp').disabled=true;
    document.getElementById('bp').innerHTML='üîê Proteger PDFs con contrase√±a';
    ['s1','s2','s3'].forEach(id=>document.getElementById(id).classList.remove('active','done'));
    document.getElementById('s1').classList.add('active');
    document.querySelectorAll('.ro').forEach(o=>o.classList.remove('sel'));
    document.querySelector('[data-value="both"]').classList.add('sel');
  }
  window.addEventListener('DOMContentLoaded',fullReset);
  window.addEventListener('pageshow',e=>{if(e.persisted)fullReset()});

  ['ze','zp'].forEach(id=>{
    const z=document.getElementById(id);
    z.addEventListener('dragover',e=>{e.preventDefault();z.classList.add('dragover')});
    z.addEventListener('dragleave',()=>z.classList.remove('dragover'));
    z.addEventListener('drop',()=>z.classList.remove('dragover'));
  });

  function setM(el){
    document.querySelectorAll('.ro').forEach(o=>o.classList.remove('sel'));
    el.classList.add('sel');matchMode=el.dataset.value;
  }

  function normalize(s){return s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/[_\-.,;:()[\]{}'"/\\]/g,' ').replace(/\s+/g,' ').trim()}
  function getWords(s){return normalize(s).split(' ').filter(w=>w.length>1)}

  async function extractText(u8){
    try{
      const copy=new Uint8Array(u8).buffer;
      const pdf=await pdfjsLib.getDocument({data:copy}).promise;
      let t='';
      for(let i=1;i<=Math.min(pdf.numPages,3);i++){
        const pg=await pdf.getPage(i);
        const c=await pg.getTextContent();
        t+=c.items.map(x=>x.str).join(' ')+' ';
      }
      return t;
    }catch(e){return ''}
  }

  // === ENCRYPT PDF using pdf-lib ‚Äî load original, save with password ===
  async function encryptPdf(u8, password){
    // Load the ORIGINAL pdf directly (not copy pages to new doc)
    const pdfDoc = await PDFLib.PDFDocument.load(u8, {
      ignoreEncryption: true,
      updateMetadata: false
    });

    // Save with encryption ‚Äî pdf-lib supports this natively
    const encrypted = await pdfDoc.save({
      userPassword: password,
      ownerPassword: password,
      permissions: {
        printing: 'highQuality',
        modifying: false,
        copying: false,
        annotating: false,
        fillingForms: false,
        contentAccessibility: true,
        documentAssembly: false,
      }
    });

    return encrypted;
  }

  // === Verify encryption by trying to open without password ===
  async function verifyEncryption(encryptedBytes){
    try{
      // Try to open WITHOUT providing a password ‚Äî should fail if encrypted
      const copy = new Uint8Array(encryptedBytes).buffer;
      const task = pdfjsLib.getDocument({data:copy});
      const pdf = await task.promise;
      // If we get here, check if it actually needs a password
      // pdf.js might open it but pages won't render
      try{
        const page = await pdf.getPage(1);
        const content = await page.getTextContent();
        // If we can read text, it's NOT properly encrypted for viewing
        return {encrypted:false, note:'PDF se abre sin contrase√±a'};
      }catch(e2){
        return {encrypted:true, note:'PDF requiere contrase√±a para leer contenido'};
      }
    }catch(e){
      if(e.name==='PasswordException' || (e.message && e.message.includes('password'))){
        return {encrypted:true, note:'PDF requiere contrase√±a para abrir ‚úì'};
      }
      return {encrypted:false, note:'Error verificando: '+e.message};
    }
  }

  // === EXCEL ===
  async function handleExcel(e){
    const file=e.target.files[0];if(!file)return;
    excelData=[];
    const d=await file.arrayBuffer();
    const wb=XLSX.read(d);const ws=wb.Sheets[wb.SheetNames[0]];
    excelData=XLSX.utils.sheet_to_json(ws,{defval:''});
    if(!excelData.length){alert('Excel vac√≠o');return}
    document.getElementById('ei').innerHTML=`<div class="fi">‚úÖ ${file.name} ‚Äî ${excelData.length} alumnos</div>`;
    document.getElementById('ei').classList.remove('hidden');
    const cols=Object.keys(excelData[0]);
    const cn=document.getElementById('cn'),cd=document.getElementById('cd');
    cn.innerHTML='';cd.innerHTML='';
    cols.forEach(c=>{cn.innerHTML+=`<option value="${c}">${c}</option>`;cd.innerHTML+=`<option value="${c}">${c}</option>`});
    const nl=cols.find(c=>/nombre|alumno|estudiante|name|apellido/i.test(c));
    const dl=cols.find(c=>/dni|documento|cedula|ci|rut|nif|carnet|c√≥digo|codigo/i.test(c));
    if(nl)cn.value=nl;if(dl)cd.value=dl;
    cn.onchange=updatePreview;cd.onchange=updatePreview;
    document.getElementById('ec').classList.remove('hidden');
    document.getElementById('s1').classList.remove('active');
    document.getElementById('s1').classList.add('done');
    document.getElementById('s2').classList.add('active');
    updatePreview();checkReady();
  }
  document.getElementById('ie').addEventListener('change',handleExcel);

  function isPdf(n){return n.toLowerCase().trim().endsWith('.pdf')}
  function isHid(n){return n.split('/').some(p=>p.startsWith('.')||p.startsWith('__MACOSX')||p==='Thumbs.db')}

  async function handlePdfs(e){
    const files=Array.from(e.target.files);if(!files.length)return;
    pdfFiles=[];
    const le=document.getElementById('pl'),lt=document.getElementById('plt'),ie=document.getElementById('pi'),de=document.getElementById('pd');
    const zf=files.find(f=>f.name.toLowerCase().endsWith('.zip'));
    if(zf){
      le.classList.remove('hidden');lt.textContent='Extrayendo PDFs del ZIP...';
      ie.classList.add('hidden');de.classList.add('hidden');
      try{
        const zd=await zf.arrayBuffer();const zip=await JSZip.loadAsync(zd);
        let db=`üì¶ "${zf.name}"\n`;
        for(const[p,en]of Object.entries(zip.files)){
          if(en.dir||isHid(p))continue;
          if(isPdf(p)){const ab=await en.async('arraybuffer');if(ab.byteLength>0){const fn=p.split('/').pop();pdfFiles.push({name:fn,data:new Uint8Array(ab)});db+=`‚úì ${fn}\n`}}
        }
        le.classList.add('hidden');
        ie.innerHTML=pdfFiles.length>0?`<div class="fi">‚úÖ ${pdfFiles.length} PDFs extra√≠dos</div>`:`<div class="fi fe">‚ùå No se encontraron .pdf</div>`;
        ie.classList.remove('hidden');
        de.innerHTML=`<div class="db">${db.replace(/\n/g,'<br>')}</div>`;de.classList.remove('hidden');
      }catch(err){le.classList.add('hidden');ie.innerHTML=`<div class="fi fe">‚ùå ${err.message}</div>`;ie.classList.remove('hidden');return}
    }else{
      le.classList.remove('hidden');lt.textContent='Cargando...';ie.classList.add('hidden');
      for(const f of files){if(isPdf(f.name)){const ab=await f.arrayBuffer();pdfFiles.push({name:f.name,data:new Uint8Array(ab)})}}
      le.classList.add('hidden');
      ie.innerHTML=pdfFiles.length>0?`<div class="fi">‚úÖ ${pdfFiles.length} PDFs</div>`:`<div class="fi fe">‚ùå Ning√∫n PDF</div>`;
      ie.classList.remove('hidden');
    }
    if(pdfFiles.length>0){document.getElementById('s2').classList.remove('active');document.getElementById('s2').classList.add('done');document.getElementById('s3').classList.add('active')}
    updatePreview();checkReady();
  }
  document.getElementById('ip').addEventListener('change',handlePdfs);

  function updatePreview(){
    if(!excelData.length)return;
    const nc=document.getElementById('cn').value,dc=document.getElementById('cd').value;
    const tb=document.getElementById('ptb');
    let h='<thead><tr><th>Nombre</th><th>DNI</th><th>Estado</th></tr></thead><tbody>';
    excelData.slice(0,5).forEach(r=>{
      const n=String(r[nc]||'').trim(),d=String(r[dc]||'').trim();
      const i=pdfFiles.length>0?'<span style="color:var(--accent);font-size:0.72rem">üìñ listo</span>':'<span style="color:var(--text2);font-size:0.72rem">‚Äî</span>';
      h+=`<tr><td>${n}</td><td>${d}</td><td>${i}</td></tr>`;
    });
    if(excelData.length>5)h+=`<tr><td colspan="3" style="color:var(--text2);text-align:center;font-family:'DM Sans'">+${excelData.length-5} m√°s</td></tr>`;
    h+='</tbody>';tb.innerHTML=h;
    document.getElementById('pc').classList.remove('hidden');
  }

  function checkReady(){document.getElementById('bp').disabled=!(excelData.length>0&&pdfFiles.length>0)}

  // === PROCESS ===
  async function processAll(){
    const nc=document.getElementById('cn').value,dc=document.getElementById('cd').value;
    const lg=document.getElementById('lg'),res=document.getElementById('res');
    const pf=document.getElementById('pf'),pt=document.getElementById('pt2');
    const sm=document.getElementById('sm'),bd=document.getElementById('bd'),bp=document.getElementById('bp');
    const ta=document.getElementById('testArea');

    res.classList.remove('hidden');sm.classList.add('hidden');bd.classList.add('hidden');ta.classList.add('hidden');
    lg.innerHTML='';pf.style.width='0%';pt.textContent='';
    bp.disabled=true;bp.innerHTML='<span class="sp"></span> Procesando...';

    resultZip=new JSZip();
    let ok=0,err=0;const tot=excelData.length;const used=new Set();

    // PHASE 1: Extract text
    lm('info',`üìñ Fase 1: Leyendo texto de ${pdfFiles.length} PDFs...`);
    const texts=[];
    for(let i=0;i<pdfFiles.length;i++){
      pt.textContent=`Leyendo PDF ${i+1}/${pdfFiles.length}...`;
      pf.style.width=Math.round(((i+1)/pdfFiles.length)*25)+'%';
      const t=await extractText(pdfFiles[i].data);texts.push(t);
      const pv=t.substring(0,80).replace(/\s+/g,' ').trim();
      lm(t.length>10?'info':'warn',t.length>10?`  üìÑ ${pdfFiles[i].name}: "${pv}..."`:`  ‚ö† ${pdfFiles[i].name}: sin texto`);
      if(i%2===0)await new Promise(r=>setTimeout(r,10));
    }

    lm('info','');lm('info',`üîç Fase 2: Asignando y encriptando...`);lm('info','');

    // PHASE 2: Match + encrypt
    let firstEncrypted = null;

    for(let i=0;i<tot;i++){
      const row=excelData[i];
      const name=String(row[nc]||'').trim(),dni=String(row[dc]||'').trim();
      pt.textContent=`Encriptando ${i+1}/${tot}...`;
      pf.style.width=(25+Math.round(((i+1)/tot)*65))+'%';

      if(!name||!dni){lm('warn',`‚ö† Fila ${i+1}: vac√≠o`);err++;continue}

      let mi=-1;

      if(matchMode==='filename'){
        const nw=getWords(name),nd=normalize(dni).replace(/\s/g,'');
        let best=0;
        for(let j=0;j<pdfFiles.length;j++){
          if(used.has(j))continue;
          const pb=normalize(pdfFiles[j].name.replace(/\.pdf$/i,''));
          if(nd.length>=6&&pb.includes(nd)){mi=j;break}
          const ws=new Set(pb.split(' ').filter(w=>w.length>1));
          let h=0;for(const w of nw){if(ws.has(w))h++}
          const s=nw.length>0?h/nw.length:0;
          if(s>best&&s>=0.7){best=s;mi=j}
        }
      }else{
        const nd=normalize(dni).replace(/[^0-9a-z]/g,'');
        const nw=getWords(name);
        let bs=0,bi=-1;
        for(let j=0;j<pdfFiles.length;j++){
          if(used.has(j))continue;
          const t=normalize(texts[j]||'');let sc=0;
          if((matchMode==='both'||matchMode==='dni_only')&&nd.length>=6){
            if(t.replace(/\s/g,'').includes(nd))sc=1.0;
          }
          if(sc<1.0&&(matchMode==='both'||matchMode==='name_only')&&nw.length>0){
            let h=0;for(const w of nw){if(t.includes(w))h++}
            const ns=h/nw.length;if(ns>sc)sc=ns;
          }
          if(sc>bs){bs=sc;bi=j}
        }
        if(matchMode==='dni_only'&&bs>=1.0)mi=bi;
        else if(matchMode!=='dni_only'&&bs>=0.7)mi=bi;
      }

      if(mi===-1){lm('err',`‚úó ${name} (${dni}) ‚Äî no encontrado`);err++;continue}

      try{
        const encBytes=await encryptPdf(pdfFiles[mi].data, dni);
        const sn=name.replace(/[/\\?%*:|"<>]/g,'-').trim();
        resultZip.file(`${sn}.pdf`,encBytes);
        used.add(mi);
        if(!firstEncrypted) firstEncrypted = encBytes;
        lm('ok',`‚úì ${name} ‚Üê ${pdfFiles[mi].name} (üîë ${dni})`);
        ok++;
      }catch(ex){lm('err',`‚úó ${name} ‚Äî ${ex.message}`);err++}

      if(i%2===0)await new Promise(r=>setTimeout(r,10));
    }

    // PHASE 3: Verify encryption on first file
    if(firstEncrypted){
      lm('info','');lm('info','üß™ Fase 3: Verificando encriptaci√≥n...');
      pf.style.width='95%';pt.textContent='Verificando...';
      const vr=await verifyEncryption(firstEncrypted);
      if(vr.encrypted){
        lm('ok',`‚úÖ Verificaci√≥n: ${vr.note}`);
      }else{
        lm('warn',`‚ö† Verificaci√≥n: ${vr.note}`);
        lm('warn','   Los PDFs se generaron pero la protecci√≥n podr√≠a ser limitada.');
        lm('warn','   Abre un PDF descargado con Adobe Reader para verificar.');
      }
    }

    const un=pdfFiles.filter((f,i)=>!used.has(i));
    if(un.length>0){lm('info','');lm('warn',`‚ö† ${un.length} PDFs sin asignar:`);un.forEach(f=>lm('warn',`   üìÑ ${f.name}`))}

    lm('info','');lm('info',`‚îÅ‚îÅ‚îÅ ‚úÖ ${ok} protegidos, ${err} sin coincidir ‚îÅ‚îÅ‚îÅ`);

    pf.style.width='100%';pt.textContent='Completado';
    document.getElementById('co').textContent=ok;
    document.getElementById('ce').textContent=err;
    document.getElementById('ct').textContent=tot;
    sm.classList.remove('hidden');
    if(ok>0)bd.classList.remove('hidden');

    bp.disabled=false;bp.innerHTML='üîê Proteger PDFs con contrase√±a';
    document.getElementById('s3').classList.remove('active');document.getElementById('s3').classList.add('done');
    res.scrollIntoView({behavior:'smooth',block:'start'});
  }

  function lm(t,m){const l=document.getElementById('lg');l.innerHTML+=`<div class="log-${t}">${m}</div>`;l.scrollTop=l.scrollHeight}

  async function downloadZip(){
    const b=document.getElementById('bd');
    b.innerHTML='<span class="sp"></span> Generando ZIP...';b.disabled=true;
    try{const bl=await resultZip.generateAsync({type:'blob'});saveAs(bl,'PDFs_protegidos.zip')}catch(e){alert(e.message)}
    b.innerHTML='‚¨áÔ∏è Descargar PDFs protegidos (.zip)';b.disabled=false;
  }
</script>
</body>
</html>
