<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Proteger PDFs con DNI</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://unpkg.com/jspdf@2.5.2/dist/jspdf.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0f1117;--sf:#1a1d27;--sf2:#232736;--bd:#2e3348;--tx:#e8e9ed;--tx2:#9096a8;--ac:#6c5ce7;--acg:rgba(108,92,231,0.25);--ok:#00b894;--er:#e17055;--wa:#fdcb6e;--r:12px}
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;padding:2rem;background-image:radial-gradient(ellipse at 20% 0%,rgba(108,92,231,.08),transparent 50%),radial-gradient(ellipse at 80% 100%,rgba(0,184,148,.06),transparent 50%)}
  .c{max-width:820px;margin:0 auto}
  header{text-align:center;margin-bottom:2.5rem}
  header h1{font-family:'Space Mono',monospace;font-size:1.8rem;font-weight:700;margin-bottom:.5rem;background:linear-gradient(135deg,#e8e9ed,#6c5ce7);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  header p{color:var(--tx2);font-size:.95rem;max-width:520px;margin:0 auto}
  .steps{display:flex;gap:1rem;margin-bottom:2rem}
  .si{flex:1;display:flex;align-items:center;gap:.6rem;padding:.8rem 1rem;background:var(--sf);border:1px solid var(--bd);border-radius:var(--r);font-size:.85rem;color:var(--tx2);transition:.3s}
  .si.a{border-color:var(--ac);color:var(--tx);box-shadow:0 0 20px var(--acg)}.si.d{border-color:var(--ok);color:var(--ok)}
  .sn{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Space Mono',monospace;font-size:.75rem;font-weight:700;background:var(--sf2);flex-shrink:0}
  .si.a .sn{background:var(--ac);color:#fff}.si.d .sn{background:var(--ok);color:#fff}
  .cd{background:var(--sf);border:1px solid var(--bd);border-radius:var(--r);padding:1.5rem;margin-bottom:1.2rem}
  .cd h3{font-size:1rem;font-weight:600;margin-bottom:.3rem}.cd .ds{font-size:.85rem;color:var(--tx2);margin-bottom:1rem}
  .uz{border:2px dashed var(--bd);border-radius:var(--r);padding:2rem;text-align:center;cursor:pointer;transition:.3s;position:relative}
  .uz:hover,.uz.dg{border-color:var(--ac);background:rgba(108,92,231,.05)}
  .uz input{position:absolute;inset:0;opacity:0;cursor:pointer}.uz .ic{font-size:2rem;margin-bottom:.5rem}
  .uz .lb{font-size:.9rem;color:var(--tx2)}.uz .lb strong{color:var(--ac)}
  .fi{display:flex;align-items:center;gap:.5rem;padding:.6rem 1rem;background:var(--sf2);border-radius:8px;font-size:.85rem;margin-top:.8rem;color:var(--ok);font-family:'Space Mono',monospace}
  .fi.fe{color:var(--er)}.fi.fw{color:var(--wa)}.fi.fa{color:var(--ac)}
  .cs{margin-top:1rem;display:flex;gap:1rem;flex-wrap:wrap}
  .cs label{font-size:.85rem;color:var(--tx2);display:block;margin-bottom:.3rem}
  .cs select{background:var(--sf2);border:1px solid var(--bd);color:var(--tx);padding:.5rem .8rem;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:.85rem;min-width:180px;cursor:pointer}
  .cs select:focus{outline:none;border-color:var(--ac)}
  .mm{margin-top:1rem}.mm>label{font-size:.85rem;color:var(--tx2);display:block;margin-bottom:.5rem}
  .rg{display:flex;gap:.5rem;flex-wrap:wrap}
  .ro{padding:.5rem 1rem;background:var(--sf2);border:1px solid var(--bd);border-radius:8px;font-size:.82rem;cursor:pointer;transition:.2s;color:var(--tx2)}
  .ro:hover{border-color:#4a5070}.ro.s{border-color:var(--ac);background:rgba(108,92,231,.12);color:var(--tx)}
  .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.9rem 2rem;border:none;border-radius:var(--r);font-family:'DM Sans',sans-serif;font-size:.95rem;font-weight:600;cursor:pointer;transition:.3s;width:100%;justify-content:center}
  .bp{background:var(--ac);color:#fff;box-shadow:0 4px 20px var(--acg)}.bp:hover:not(:disabled){transform:translateY(-1px)}.bp:disabled{opacity:.4;cursor:not-allowed}
  .bs{background:transparent;color:var(--tx2);border:1px solid var(--bd);padding:.6rem 1.2rem;font-size:.85rem;width:auto}.bs:hover{border-color:var(--ac);color:var(--tx)}
  .bd{background:var(--ok);color:#fff;margin-top:1rem}.bd:hover{transform:translateY(-1px)}
  .pbb{height:6px;background:var(--sf2);border-radius:3px;overflow:hidden;margin-bottom:.8rem}
  .pbf{height:100%;background:linear-gradient(90deg,var(--ac),var(--ok));border-radius:3px;transition:width .3s}
  .log{max-height:300px;overflow-y:auto;font-family:'Space Mono',monospace;font-size:.73rem;line-height:1.7;padding:1rem;background:var(--bg);border-radius:8px;border:1px solid var(--bd)}
  .log-ok{color:var(--ok)}.log-err{color:var(--er)}.log-warn{color:var(--wa)}.log-info{color:var(--tx2)}
  .sum{display:flex;gap:1rem;margin:1rem 0}
  .sui{flex:1;text-align:center;padding:1rem;background:var(--sf2);border-radius:8px}
  .sui .nm{font-family:'Space Mono',monospace;font-size:1.5rem;font-weight:700}
  .sui .ll{font-size:.78rem;color:var(--tx2);margin-top:.2rem}
  .pt{width:100%;border-collapse:collapse;font-size:.82rem;margin-top:.8rem}
  .pt th{text-align:left;padding:.5rem .8rem;color:var(--tx2);font-weight:500;border-bottom:1px solid var(--bd)}
  .pt td{padding:.5rem .8rem;border-bottom:1px solid rgba(46,51,72,.5);font-family:'Space Mono',monospace;font-size:.73rem}
  .hd{display:none}
  .tip{display:flex;align-items:flex-start;gap:.5rem;padding:.8rem 1rem;background:rgba(108,92,231,.08);border:1px solid rgba(108,92,231,.2);border-radius:8px;font-size:.82rem;color:var(--tx2);margin-top:1rem;line-height:1.5}
  .tip strong{color:var(--ac)}
  .db{margin-top:.8rem;padding:.8rem 1rem;background:var(--bg);border:1px solid var(--bd);border-radius:8px;font-family:'Space Mono',monospace;font-size:.72rem;color:var(--tx2);max-height:150px;overflow-y:auto;line-height:1.6}
  .sp{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .rb{display:flex;justify-content:flex-end;margin-bottom:.5rem}
  @media(max-width:600px){body{padding:1rem}.steps,.sum,.cs,.rg{flex-direction:column}header h1{font-size:1.4rem}}
  .log::-webkit-scrollbar,.db::-webkit-scrollbar{width:4px}.log::-webkit-scrollbar-thumb,.db::-webkit-scrollbar-thumb{background:var(--bd);border-radius:2px}
</style>
</head>
<body>
<div class="c">
  <header>
    <h1>üîê Proteger PDFs con DNI</h1>
    <p>Sube tu Excel y un ZIP con los PDFs. La app identifica cada alumno y protege su PDF con contrase√±a real.</p>
  </header>
  <div class="rb"><button class="btn bs" onclick="fullReset()">üóëÔ∏è Limpiar todo</button></div>
  <div class="steps">
    <div class="si a" id="s1"><span class="sn">1</span> Excel</div>
    <div class="si" id="s2"><span class="sn">2</span> PDFs</div>
    <div class="si" id="s3"><span class="sn">3</span> Procesar</div>
  </div>

  <div class="cd">
    <h3>üìä Excel con alumnos</h3>
    <p class="ds">Columna con nombres y otra con DNI.</p>
    <div class="uz" id="ze"><input type="file" accept=".xlsx,.xls,.csv" id="ie" autocomplete="off"><div class="ic">üìÑ</div><div class="lb"><strong>Clic</strong> o arrastra ‚Äî .xlsx .csv</div></div>
    <div id="ei" class="hd"></div>
    <div id="ec" class="hd">
      <div class="cs"><div><label>Columna nombre:</label><select id="cn"></select></div><div><label>Columna DNI:</label><select id="cdd"></select></div></div>
      <div id="pc" class="hd" style="margin-top:1rem;overflow-x:auto"><table class="pt" id="ptb"></table></div>
    </div>
  </div>

  <div class="cd">
    <h3>üìÅ PDFs de alumnos</h3>
    <p class="ds"><strong>.zip</strong> o PDFs sueltos. Lee el contenido para identificar cada alumno.</p>
    <div class="uz" id="zp"><input type="file" accept=".pdf,.zip" multiple id="ip" autocomplete="off"><div class="ic">üì¶</div><div class="lb"><strong>.zip</strong> o m√∫ltiples <strong>PDFs</strong></div></div>
    <div id="pl" class="hd" style="margin-top:.8rem"><div class="fi fa"><span class="sp"></span> <span id="plt">Extrayendo...</span></div></div>
    <div id="pi" class="hd"></div><div id="pd" class="hd"></div>
    <div class="mm">
      <label>¬øQu√© buscar dentro de los PDFs?</label>
      <div class="rg">
        <div class="ro s" data-v="both" onclick="setM(this)">üß† Nombre y DNI</div>
        <div class="ro" data-v="dni_only" onclick="setM(this)">Solo DNI</div>
        <div class="ro" data-v="name_only" onclick="setM(this)">Solo nombre</div>
        <div class="ro" data-v="filename" onclick="setM(this)">Por archivo</div>
      </div>
    </div>
    <div class="tip">üí° <span>Los PDFs se protegen con <strong>encriptaci√≥n real</strong> (jsPDF). Se renderizan a alta calidad (300 DPI). Al abrir pedir√° contrase√±a.</span></div>
  </div>

  <button class="btn bp" id="bp" disabled onclick="processAll()">üîê Proteger PDFs con contrase√±a</button>

  <div id="res" class="hd">
    <div class="cd" style="margin-top:1.2rem">
      <h3>üìã Resultado</h3>
      <div style="margin-top:1.2rem"><div class="pbb"><div class="pbf" id="pf" style="width:0%"></div></div>
      <div id="pt2" style="font-size:.8rem;color:var(--tx2);text-align:center"></div></div>
      <div class="sum hd" id="sm">
        <div class="sui"><div class="nm log-ok" id="co">0</div><div class="ll">Protegidos</div></div>
        <div class="sui"><div class="nm log-err" id="ce">0</div><div class="ll">Sin match</div></div>
        <div class="sui"><div class="nm" style="color:var(--tx)" id="ct">0</div><div class="ll">Total</div></div>
      </div>
      <div class="log" id="lg"></div>
      <button class="btn bd hd" id="bdd" onclick="downloadZip()">‚¨áÔ∏è Descargar PDFs protegidos (.zip)</button>
    </div>
  </div>
</div>

<canvas id="cv" style="display:none"></canvas>

<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  // Verify jsPDF loaded
  let jsPDFClass = null;
  if(window.jspdf && window.jspdf.jsPDF){
    jsPDFClass = window.jspdf.jsPDF;
    console.log('‚úÖ jsPDF loaded correctly');
  } else {
    console.error('‚ùå jsPDF not loaded!');
  }

  let excelData=[],pdfFiles=[],matchMode='both',resultZip=null;

  function fullReset(){
    excelData=[];pdfFiles=[];matchMode='both';resultZip=null;
    const a=document.getElementById('ie'),b=document.getElementById('ip');
    a.value='';b.value='';
    const na=a.cloneNode(true),nb=b.cloneNode(true);
    a.parentNode.replaceChild(na,a);b.parentNode.replaceChild(nb,b);
    na.addEventListener('change',handleExcel);nb.addEventListener('change',handlePdfs);
    ['ei','ec','pc','pi','pl','pd','res','sm','bdd'].forEach(id=>document.getElementById(id).classList.add('hd'));
    document.getElementById('lg').innerHTML='';
    document.getElementById('pf').style.width='0%';
    document.getElementById('pt2').textContent='';
    document.getElementById('bp').disabled=true;
    document.getElementById('bp').innerHTML='üîê Proteger PDFs con contrase√±a';
    ['s1','s2','s3'].forEach(id=>{document.getElementById(id).classList.remove('a','d')});
    document.getElementById('s1').classList.add('a');
    document.querySelectorAll('.ro').forEach(o=>o.classList.remove('s'));
    document.querySelector('[data-v="both"]').classList.add('s');
  }
  window.addEventListener('DOMContentLoaded',fullReset);
  window.addEventListener('pageshow',e=>{if(e.persisted)fullReset()});

  ['ze','zp'].forEach(id=>{const z=document.getElementById(id);z.addEventListener('dragover',e=>{e.preventDefault();z.classList.add('dg')});z.addEventListener('dragleave',()=>z.classList.remove('dg'));z.addEventListener('drop',()=>z.classList.remove('dg'))});

  function setM(el){document.querySelectorAll('.ro').forEach(o=>o.classList.remove('s'));el.classList.add('s');matchMode=el.dataset.v}
  function normalize(s){return s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/[_\-.,;:()[\]{}'"/\\]/g,' ').replace(/\s+/g,' ').trim()}
  function getWords(s){return normalize(s).split(' ').filter(w=>w.length>1)}

  async function extractText(u8){
    try{
      const copy=new Uint8Array(u8).buffer;
      const pdf=await pdfjsLib.getDocument({data:copy}).promise;
      let t='';
      for(let i=1;i<=Math.min(pdf.numPages,3);i++){
        const pg=await pdf.getPage(i);const c=await pg.getTextContent();
        t+=c.items.map(x=>x.str).join(' ')+' ';
      }
      return t;
    }catch(e){return ''}
  }

  // === REAL ENCRYPTION: Render PDF pages to canvas, create encrypted jsPDF ===
  async function createEncryptedPdf(u8, password){
    if(!jsPDFClass) throw new Error('jsPDF no se carg√≥ correctamente');

    const copy=new Uint8Array(u8).buffer;
    const pdf=await pdfjsLib.getDocument({data:copy}).promise;
    const canvas=document.getElementById('cv');
    const ctx=canvas.getContext('2d');

    const SCALE = 300 / 72; // 300 DPI (72 is PDF default DPI)
    let doc=null;

    for(let i=1;i<=pdf.numPages;i++){
      const page=await pdf.getPage(i);
      const vp=page.getViewport({scale:SCALE});

      canvas.width=vp.width;
      canvas.height=vp.height;
      ctx.fillStyle='#ffffff';
      ctx.fillRect(0,0,canvas.width,canvas.height);

      await page.render({canvasContext:ctx,viewport:vp}).promise;

      // Get image data as JPEG (high quality)
      const imgData=canvas.toDataURL('image/jpeg',0.95);

      // Page dimensions in mm
      const origVp=page.getViewport({scale:1});
      const wMm=(origVp.width/72)*25.4;
      const hMm=(origVp.height/72)*25.4;

      if(i===1){
        doc=new jsPDFClass({
          orientation:wMm>hMm?'landscape':'portrait',
          unit:'mm',
          format:[wMm,hMm],
          encryption:{
            userPassword:password,
            ownerPassword:password+'_owner',
            userPermissions:['print']
          }
        });
      }else{
        doc.addPage([wMm,hMm],wMm>hMm?'landscape':'portrait');
      }

      doc.addImage(imgData,'JPEG',0,0,wMm,hMm,undefined,'FAST');
    }

    if(!doc) throw new Error('PDF sin p√°ginas');
    return doc.output('arraybuffer');
  }

  // === Verify ===
  async function verifyEncryption(bytes){
    try{
      const copy=new Uint8Array(bytes).buffer;
      await pdfjsLib.getDocument({data:copy}).promise;
      return {ok:false,msg:'Se abre sin contrase√±a ‚ö†'};
    }catch(e){
      if(e.name==='PasswordException'||String(e).includes('password'))
        return {ok:true,msg:'Requiere contrase√±a ‚úÖ'};
      return {ok:false,msg:'Error: '+e.message};
    }
  }

  // === EXCEL ===
  async function handleExcel(e){
    const f=e.target.files[0];if(!f)return;excelData=[];
    const d=await f.arrayBuffer();const wb=XLSX.read(d);
    excelData=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:''});
    if(!excelData.length){alert('Excel vac√≠o');return}
    document.getElementById('ei').innerHTML=`<div class="fi">‚úÖ ${f.name} ‚Äî ${excelData.length} alumnos</div>`;
    document.getElementById('ei').classList.remove('hd');
    const cols=Object.keys(excelData[0]);
    const cn=document.getElementById('cn'),cd=document.getElementById('cdd');
    cn.innerHTML='';cd.innerHTML='';
    cols.forEach(c=>{cn.innerHTML+=`<option value="${c}">${c}</option>`;cd.innerHTML+=`<option value="${c}">${c}</option>`});
    const nl=cols.find(c=>/nombre|alumno|estudiante|name|apellido/i.test(c));
    const dl=cols.find(c=>/dni|documento|cedula|ci|rut|nif|carnet|c√≥digo|codigo/i.test(c));
    if(nl)cn.value=nl;if(dl)cd.value=dl;
    cn.onchange=updatePreview;cd.onchange=updatePreview;
    document.getElementById('ec').classList.remove('hd');
    document.getElementById('s1').classList.remove('a');document.getElementById('s1').classList.add('d');
    document.getElementById('s2').classList.add('a');
    updatePreview();checkReady();
  }
  document.getElementById('ie').addEventListener('change',handleExcel);

  function isPdf(n){return n.toLowerCase().trim().endsWith('.pdf')}
  function isHid(n){return n.split('/').some(p=>p.startsWith('.')||p.startsWith('__MACOSX')||p==='Thumbs.db')}

  async function handlePdfs(e){
    const files=Array.from(e.target.files);if(!files.length)return;pdfFiles=[];
    const le=document.getElementById('pl'),lt=document.getElementById('plt'),ie=document.getElementById('pi'),de=document.getElementById('pd');
    const zf=files.find(f=>f.name.toLowerCase().endsWith('.zip'));
    if(zf){
      le.classList.remove('hd');lt.textContent='Extrayendo...';ie.classList.add('hd');de.classList.add('hd');
      try{
        const z=await JSZip.loadAsync(await zf.arrayBuffer());let db=`üì¶ ${zf.name}\n`;
        for(const[p,en]of Object.entries(z.files)){
          if(en.dir||isHid(p))continue;
          if(isPdf(p)){const ab=await en.async('arraybuffer');if(ab.byteLength>0){const fn=p.split('/').pop();pdfFiles.push({name:fn,data:new Uint8Array(ab)});db+=`‚úì ${fn}\n`}}
        }
        le.classList.add('hd');
        ie.innerHTML=pdfFiles.length?`<div class="fi">‚úÖ ${pdfFiles.length} PDFs</div>`:`<div class="fi fe">‚ùå Sin .pdf</div>`;
        ie.classList.remove('hd');de.innerHTML=`<div class="db">${db.replace(/\n/g,'<br>')}</div>`;de.classList.remove('hd');
      }catch(er){le.classList.add('hd');ie.innerHTML=`<div class="fi fe">‚ùå ${er.message}</div>`;ie.classList.remove('hd');return}
    }else{
      le.classList.remove('hd');lt.textContent='Cargando...';ie.classList.add('hd');
      for(const f of files){if(isPdf(f.name)){pdfFiles.push({name:f.name,data:new Uint8Array(await f.arrayBuffer())})}}
      le.classList.add('hd');ie.innerHTML=pdfFiles.length?`<div class="fi">‚úÖ ${pdfFiles.length} PDFs</div>`:`<div class="fi fe">‚ùå Ninguno</div>`;ie.classList.remove('hd');
    }
    if(pdfFiles.length){document.getElementById('s2').classList.remove('a');document.getElementById('s2').classList.add('d');document.getElementById('s3').classList.add('a')}
    updatePreview();checkReady();
  }
  document.getElementById('ip').addEventListener('change',handlePdfs);

  function updatePreview(){
    if(!excelData.length)return;
    const nc=document.getElementById('cn').value,dc=document.getElementById('cdd').value,tb=document.getElementById('ptb');
    let h='<thead><tr><th>Nombre</th><th>DNI</th><th></th></tr></thead><tbody>';
    excelData.slice(0,4).forEach(r=>{
      h+=`<tr><td>${String(r[nc]||'').trim()}</td><td>${String(r[dc]||'').trim()}</td><td style="color:var(--ac);font-size:.72rem">${pdfFiles.length?'üìñ listo':'‚Äî'}</td></tr>`;
    });
    if(excelData.length>4)h+=`<tr><td colspan="3" style="color:var(--tx2);text-align:center;font-family:'DM Sans'">+${excelData.length-4} m√°s</td></tr>`;
    h+='</tbody>';tb.innerHTML=h;document.getElementById('pc').classList.remove('hd');
  }
  function checkReady(){document.getElementById('bp').disabled=!(excelData.length&&pdfFiles.length)}

  // === MAIN PROCESS ===
  async function processAll(){
    if(!jsPDFClass){alert('Error: jsPDF no se carg√≥. Recarga la p√°gina.');return}

    const nc=document.getElementById('cn').value,dc=document.getElementById('cdd').value;
    const lg=document.getElementById('lg'),res=document.getElementById('res');
    const pf=document.getElementById('pf'),pt=document.getElementById('pt2');
    const sm=document.getElementById('sm'),bdd=document.getElementById('bdd'),bp=document.getElementById('bp');

    res.classList.remove('hd');sm.classList.add('hd');bdd.classList.add('hd');
    lg.innerHTML='';pf.style.width='0%';pt.textContent='';
    bp.disabled=true;bp.innerHTML='<span class="sp"></span> Procesando...';

    resultZip=new JSZip();
    let ok=0,err=0;const tot=excelData.length,used=new Set();

    // Phase 1
    lm('info',`üìñ Leyendo texto de ${pdfFiles.length} PDFs...`);
    const texts=[];
    for(let i=0;i<pdfFiles.length;i++){
      pt.textContent=`Leyendo ${i+1}/${pdfFiles.length}...`;
      pf.style.width=Math.round(((i+1)/pdfFiles.length)*20)+'%';
      const t=await extractText(pdfFiles[i].data);texts.push(t);
      const pv=t.substring(0,70).replace(/\s+/g,' ').trim();
      lm(t.length>10?'info':'warn',t.length>10?`  üìÑ ${pdfFiles[i].name}: "${pv}..."`:`  ‚ö† ${pdfFiles[i].name}: sin texto`);
      if(i%2===0)await tick();
    }

    lm('info','');lm('info',`üîê Encriptando ${tot} PDFs con contrase√±a...`);lm('info','');

    // Phase 2
    let firstBytes=null;
    for(let i=0;i<tot;i++){
      const row=excelData[i],name=String(row[nc]||'').trim(),dni=String(row[dc]||'').trim();
      pt.textContent=`Encriptando ${i+1}/${tot}: ${name.substring(0,25)}...`;
      pf.style.width=(20+Math.round(((i+1)/tot)*70))+'%';

      if(!name||!dni){lm('warn',`‚ö† Fila ${i+1}: vac√≠o`);err++;continue}

      const mi=findMatch(name,dni,texts,used);

      if(mi===-1){lm('err',`‚úó ${name} (${dni}) ‚Äî no encontrado`);err++;continue}

      try{
        const encBytes=await createEncryptedPdf(pdfFiles[mi].data,dni);
        const safeName=name.replace(/[/\\?%*:|"<>]/g,'-').trim();
        resultZip.file(`${safeName}.pdf`,encBytes);
        used.add(mi);
        if(!firstBytes)firstBytes=encBytes;
        lm('ok',`‚úì ${name} ‚Üê ${pdfFiles[mi].name} (üîë ${dni})`);
        ok++;
      }catch(ex){lm('err',`‚úó ${name} ‚Äî ${ex.message}`);err++}
      if(i%2===0)await tick();
    }

    // Phase 3: Verify
    if(firstBytes){
      lm('info','');lm('info','üß™ Verificando encriptaci√≥n...');
      pt.textContent='Verificando...';pf.style.width='95%';
      const v=await verifyEncryption(firstBytes);
      lm(v.ok?'ok':'warn',`  ${v.msg}`);
    }

    const un=pdfFiles.filter((_,i)=>!used.has(i));
    if(un.length){lm('info','');lm('warn',`‚ö† ${un.length} PDFs sin asignar:`);un.forEach(f=>lm('warn',`   üìÑ ${f.name}`))}

    lm('info','');lm('info',`‚îÅ‚îÅ‚îÅ ${ok} protegidos ‚úÖ | ${err} sin match ‚îÅ‚îÅ‚îÅ`);

    pf.style.width='100%';pt.textContent='‚úÖ Completado';
    document.getElementById('co').textContent=ok;document.getElementById('ce').textContent=err;document.getElementById('ct').textContent=tot;
    sm.classList.remove('hd');if(ok)bdd.classList.remove('hd');

    bp.disabled=false;bp.innerHTML='üîê Proteger PDFs con contrase√±a';
    document.getElementById('s3').classList.remove('a');document.getElementById('s3').classList.add('d');
    res.scrollIntoView({behavior:'smooth',block:'start'});
  }

  function findMatch(name,dni,texts,used){
    if(matchMode==='filename'){
      const nw=getWords(name),nd=normalize(dni).replace(/\s/g,'');
      let best=0,bi=-1;
      for(let j=0;j<pdfFiles.length;j++){
        if(used.has(j))continue;
        const pb=normalize(pdfFiles[j].name.replace(/\.pdf$/i,''));
        if(nd.length>=6&&pb.includes(nd))return j;
        const ws=new Set(pb.split(' ').filter(w=>w.length>1));
        let h=0;for(const w of nw){if(ws.has(w))h++}
        const s=nw.length?h/nw.length:0;if(s>best&&s>=.7){best=s;bi=j}
      }
      return bi;
    }
    const nd=normalize(dni).replace(/[^0-9a-z]/g,''),nw=getWords(name);
    let bs=0,bi=-1;
    for(let j=0;j<pdfFiles.length;j++){
      if(used.has(j))continue;
      const t=normalize(texts[j]||'');let sc=0;
      if((matchMode==='both'||matchMode==='dni_only')&&nd.length>=6&&t.replace(/\s/g,'').includes(nd))sc=1;
      if(sc<1&&(matchMode==='both'||matchMode==='name_only')&&nw.length){
        let h=0;for(const w of nw){if(t.includes(w))h++}
        const ns=h/nw.length;if(ns>sc)sc=ns;
      }
      if(sc>bs){bs=sc;bi=j}
    }
    if(matchMode==='dni_only')return bs>=1?bi:-1;
    return bs>=.7?bi:-1;
  }

  function lm(t,m){const l=document.getElementById('lg');l.innerHTML+=`<div class="log-${t}">${m}</div>`;l.scrollTop=l.scrollHeight}
  function tick(){return new Promise(r=>setTimeout(r,10))}

  async function downloadZip(){
    const b=document.getElementById('bdd');b.innerHTML='<span class="sp"></span> Generando...';b.disabled=true;
    try{saveAs(await resultZip.generateAsync({type:'blob'}),'PDFs_protegidos.zip')}catch(e){alert(e.message)}
    b.innerHTML='‚¨áÔ∏è Descargar PDFs protegidos (.zip)';b.disabled=false;
  }
</script>
</body>
</html>
