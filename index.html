<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Proteger PDFs con DNI - Lectura Inteligente</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0c10;
    --surface: #12151c;
    --surface2: #1a1f2a;
    --border: #252d3d;
    --text: #e8eaef;
    --text2: #8892a8;
    --accent: #10b981;
    --accent-glow: rgba(16, 185, 129, 0.2);
    --purple: #8b5cf6;
    --purple-glow: rgba(139, 92, 246, 0.2);
    --error: #ef4444;
    --warning: #f59e0b;
    --radius: 14px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding: 2rem;
    background-image: 
      radial-gradient(ellipse at 10% 10%, rgba(16, 185, 129, 0.06) 0%, transparent 40%),
      radial-gradient(ellipse at 90% 90%, rgba(139, 92, 246, 0.05) 0%, transparent 40%);
  }

  .container { max-width: 900px; margin: 0 auto; }

  header { text-align: center; margin-bottom: 2.5rem; }

  header h1 {
    font-family: 'Space Mono', monospace;
    font-size: 1.7rem;
    font-weight: 700;
    letter-spacing: -0.5px;
    margin-bottom: 0.5rem;
    background: linear-gradient(135deg, #10b981 0%, #8b5cf6 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  header p { color: var(--text2); font-size: 0.92rem; max-width: 600px; margin: 0 auto; line-height: 1.6; }

  .badge {
    display: inline-flex; align-items: center; gap: 0.4rem;
    background: rgba(139, 92, 246, 0.12); border: 1px solid rgba(139, 92, 246, 0.3);
    padding: 0.35rem 0.8rem; border-radius: 20px;
    font-size: 0.72rem; color: var(--purple); margin-bottom: 1rem;
    font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
  }

  .steps { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.8rem; margin-bottom: 2rem; }

  .step-indicator {
    display: flex; align-items: center; gap: 0.6rem;
    padding: 0.9rem 1rem; background: var(--surface);
    border: 1px solid var(--border); border-radius: var(--radius);
    font-size: 0.82rem; color: var(--text2); transition: all 0.3s;
  }

  .step-indicator.active { border-color: var(--accent); color: var(--text); box-shadow: 0 0 25px var(--accent-glow); }
  .step-indicator.done { border-color: var(--accent); color: var(--accent); }

  .step-num {
    width: 28px; height: 28px; border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Space Mono', monospace; font-size: 0.75rem; font-weight: 700;
    background: var(--surface2); flex-shrink: 0;
  }

  .step-indicator.active .step-num { background: var(--accent); color: var(--bg); }
  .step-indicator.done .step-num { background: var(--accent); color: var(--bg); }
  .step-indicator.done .step-num::after { content: '‚úì'; }
  .step-indicator.done .step-num span { display: none; }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1.5rem;
    margin-bottom: 1.2rem;
    transition: all 0.3s;
  }

  .card:hover { border-color: #3a4560; }
  .card h3 { font-size: 1rem; font-weight: 600; margin-bottom: 0.3rem; display: flex; align-items: center; gap: 0.5rem; }
  .card .desc { font-size: 0.85rem; color: var(--text2); margin-bottom: 1rem; line-height: 1.5; }

  .upload-zone {
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
  }

  .upload-zone:hover, .upload-zone.dragover { border-color: var(--accent); background: rgba(16, 185, 129, 0.04); }
  .upload-zone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
  .upload-zone .icon { font-size: 2.2rem; margin-bottom: 0.5rem; }
  .upload-zone .label { font-size: 0.9rem; color: var(--text2); }
  .upload-zone .label strong { color: var(--accent); }

  .file-info {
    display: flex; align-items: center; gap: 0.5rem;
    padding: 0.7rem 1rem; background: var(--surface2);
    border-radius: 10px; font-size: 0.85rem; margin-top: 0.8rem;
    color: var(--accent); font-family: 'Space Mono', monospace;
    border: 1px solid rgba(16, 185, 129, 0.2);
  }

  .column-select { margin-top: 1rem; display: flex; gap: 1rem; flex-wrap: wrap; }
  .column-select label { font-size: 0.85rem; color: var(--text2); display: block; margin-bottom: 0.3rem; }

  .column-select select {
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); padding: 0.55rem 0.9rem; border-radius: 10px;
    font-family: 'DM Sans', sans-serif; font-size: 0.85rem;
    min-width: 200px; cursor: pointer;
  }

  .column-select select:focus { outline: none; border-color: var(--accent); }

  .feature-box {
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.08) 0%, rgba(16, 185, 129, 0.08) 100%);
    border: 1px solid rgba(139, 92, 246, 0.2);
    border-radius: var(--radius); padding: 1.2rem; margin-top: 1rem;
  }

  .feature-box h4 { font-size: 0.9rem; color: var(--purple); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
  .feature-box p { font-size: 0.82rem; color: var(--text2); line-height: 1.6; }

  .btn {
    display: inline-flex; align-items: center; gap: 0.5rem;
    padding: 0.95rem 2rem; border: none; border-radius: var(--radius);
    font-family: 'DM Sans', sans-serif; font-size: 0.95rem; font-weight: 600;
    cursor: pointer; transition: all 0.3s; width: 100%; justify-content: center;
  }

  .btn-primary { 
    background: linear-gradient(135deg, var(--accent) 0%, #059669 100%); 
    color: white; 
    box-shadow: 0 4px 20px var(--accent-glow); 
  }
  .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(16, 185, 129, 0.35); }
  .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  .btn-download { 
    background: linear-gradient(135deg, var(--purple) 0%, #7c3aed 100%); 
    color: white; 
    margin-top: 1rem; 
    box-shadow: 0 4px 20px var(--purple-glow);
  }
  .btn-download:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(139, 92, 246, 0.35); }

  .progress-area { margin-top: 1.2rem; }
  .progress-bar-bg { height: 8px; background: var(--surface2); border-radius: 4px; overflow: hidden; margin-bottom: 0.8rem; }
  .progress-bar-fill {
    height: 100%; 
    background: linear-gradient(90deg, var(--accent), var(--purple));
    border-radius: 4px; transition: width 0.3s;
  }

  .log {
    max-height: 320px; overflow-y: auto;
    font-family: 'Space Mono', monospace; font-size: 0.73rem; line-height: 1.8;
    padding: 1rem; background: var(--bg); border-radius: 10px; border: 1px solid var(--border);
  }

  .log::-webkit-scrollbar { width: 6px; }
  .log::-webkit-scrollbar-track { background: var(--surface2); border-radius: 3px; }
  .log::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .log-ok { color: var(--accent); }
  .log-err { color: var(--error); }
  .log-warn { color: var(--warning); }
  .log-info { color: var(--text2); }
  .log-scan { color: var(--purple); }

  .summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem; margin-bottom: 1rem; }

  .summary-item {
    text-align: center; padding: 1.2rem;
    background: var(--surface2); border-radius: 12px;
    border: 1px solid var(--border);
  }

  .summary-item .num { font-family: 'Space Mono', monospace; font-size: 1.8rem; font-weight: 700; }
  .summary-item.ok .num { color: var(--accent); }
  .summary-item.err .num { color: var(--error); }
  .summary-item .lbl { font-size: 0.78rem; color: var(--text2); margin-top: 0.3rem; }

  .preview-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; margin-top: 0.8rem; }
  .preview-table th { text-align: left; padding: 0.6rem 0.8rem; color: var(--text2); font-weight: 500; border-bottom: 1px solid var(--border); }
  .preview-table td { padding: 0.6rem 0.8rem; border-bottom: 1px solid rgba(37, 45, 61, 0.5); font-family: 'Space Mono', monospace; font-size: 0.72rem; }

  .tag { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 6px; font-size: 0.72rem; }
  .tag-ok { background: rgba(16, 185, 129, 0.15); color: var(--accent); }
  .tag-no { background: rgba(239, 68, 68, 0.15); color: var(--error); }
  .tag-pending { background: rgba(139, 92, 246, 0.15); color: var(--purple); }

  .hidden { display: none; }

  .scan-status {
    display: flex; align-items: center; gap: 0.6rem;
    padding: 0.8rem 1rem; background: rgba(139, 92, 246, 0.1);
    border: 1px solid rgba(139, 92, 246, 0.25);
    border-radius: 10px; font-size: 0.85rem; color: var(--purple);
    margin-top: 0.8rem;
  }

  .loading-spinner {
    display: inline-block; width: 16px; height: 16px;
    border: 2px solid rgba(255,255,255,0.2);
    border-top-color: currentColor;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .rename-options { margin-top: 1rem; }
  .rename-options > label { font-size: 0.85rem; color: var(--text2); display: block; margin-bottom: 0.6rem; }
  
  .radio-group { display: flex; gap: 0.5rem; flex-wrap: wrap; }

  .radio-option {
    padding: 0.55rem 1rem; background: var(--surface2);
    border: 1px solid var(--border); border-radius: 10px;
    font-size: 0.82rem; cursor: pointer; transition: all 0.2s; color: var(--text2);
  }

  .radio-option:hover { border-color: #4a5a7a; }
  .radio-option.selected { border-color: var(--accent); background: rgba(16, 185, 129, 0.1); color: var(--text); }

  @media (max-width: 700px) {
    .steps { grid-template-columns: 1fr; }
    .summary { grid-template-columns: 1fr; }
    .column-select { flex-direction: column; }
    .column-select select { width: 100%; }
  }
</style>
</head>
<body>

<div class="container">
  <header>
    <div class="badge">üß† Lectura inteligente de PDFs</div>
    <h1>Proteger PDFs con DNI</h1>
    <p>Sube tu Excel y los PDFs (aunque tengan nombres gen√©ricos). El sistema <strong>leer√° el contenido</strong> de cada PDF para encontrar el DNI y asociarlo autom√°ticamente con el alumno correcto.</p>
  </header>

  <div class="steps">
    <div class="step-indicator active" id="step1-ind">
      <div class="step-num"><span>1</span></div>
      <span>Subir Excel</span>
    </div>
    <div class="step-indicator" id="step2-ind">
      <div class="step-num"><span>2</span></div>
      <span>Subir PDFs</span>
    </div>
    <div class="step-indicator" id="step3-ind">
      <div class="step-num"><span>3</span></div>
      <span>Procesar</span>
    </div>
  </div>

  <!-- EXCEL -->
  <div class="card">
    <h3>üìä Lista de alumnos (Excel)</h3>
    <p class="desc">Archivo con columnas de nombre completo y DNI de cada alumno.</p>
    <div class="upload-zone" id="excel-zone">
      <div class="icon">üìÅ</div>
      <div class="label">Arrastra tu archivo Excel aqu√≠ o <strong>haz clic para seleccionar</strong></div>
      <input type="file" accept=".xlsx,.xls,.csv" id="excel-input">
    </div>
    <div id="excel-info" class="hidden"></div>
    <div class="column-select hidden" id="column-select">
      <div>
        <label>Columna de Nombre</label>
        <select id="col-name"></select>
      </div>
      <div>
        <label>Columna de DNI</label>
        <select id="col-dni"></select>
      </div>
    </div>
  </div>

  <!-- PDFs -->
  <div class="card">
    <h3>üìÑ Archivos PDF</h3>
    <p class="desc">Sube los PDFs aunque tengan nombres gen√©ricos como "documento(1).pdf". El sistema leer√° su contenido para identificar a qui√©n pertenece cada uno.</p>
    <div class="upload-zone" id="pdf-zone">
      <div class="icon">üìë</div>
      <div class="label">Arrastra tus PDFs o un ZIP aqu√≠ o <strong>haz clic para seleccionar</strong></div>
      <input type="file" accept=".pdf,.zip" multiple id="pdf-input">
    </div>
    <div id="pdf-loading" class="hidden scan-status">
      <span class="loading-spinner"></span>
      <span>Cargando archivos...</span>
    </div>
    <div id="pdf-scanning" class="hidden scan-status">
      <span class="loading-spinner"></span>
      <span id="scan-text">Escaneando contenido de PDFs...</span>
    </div>
    <div id="pdf-info" class="hidden"></div>
    
    <div class="feature-box">
      <h4>üîç ¬øC√≥mo funciona?</h4>
      <p>El sistema extrae el texto de cada PDF y busca el DNI de los alumnos del Excel. As√≠ puede asociar correctamente cada documento aunque el nombre del archivo sea gen√©rico.</p>
    </div>
  </div>

  <!-- PREVIEW -->
  <div class="card hidden" id="preview-container">
    <h3>üëÅÔ∏è Vista previa del emparejamiento</h3>
    <p class="desc">Verificaci√≥n de qu√© PDF corresponde a cada alumno (basado en DNI encontrado dentro del PDF).</p>
    <table class="preview-table" id="preview-table"></table>
  </div>

  <!-- OPCIONES -->
  <div class="card hidden" id="options-card">
    <h3>‚öôÔ∏è Opciones de exportaci√≥n</h3>
    <div class="rename-options">
      <label>¬øC√≥mo nombrar los PDFs protegidos?</label>
      <div class="radio-group" id="rename-options">
        <div class="radio-option selected" data-value="nombre_dni">Nombre_DNI.pdf</div>
        <div class="radio-option" data-value="dni_nombre">DNI_Nombre.pdf</div>
        <div class="radio-option" data-value="solo_nombre">Nombre.pdf</div>
        <div class="radio-option" data-value="original">Mantener original</div>
      </div>
    </div>
  </div>

  <!-- PROCESS -->
  <div class="card">
    <button class="btn btn-primary" id="btn-process" disabled>
      üîê Escanear PDFs y Proteger con Contrase√±a
    </button>
  </div>

  <!-- RESULTS -->
  <div class="card hidden" id="results">
    <h3>üìã Resultado del proceso</h3>
    <div class="progress-area">
      <div class="progress-bar-bg">
        <div class="progress-bar-fill" id="progress-fill" style="width: 0%"></div>
      </div>
      <div id="progress-text" style="font-size: 0.82rem; color: var(--text2);"></div>
    </div>
    <div class="log" id="log"></div>
    <div class="summary hidden" id="summary">
      <div class="summary-item ok">
        <div class="num" id="count-ok">0</div>
        <div class="lbl">Protegidos</div>
      </div>
      <div class="summary-item err">
        <div class="num" id="count-err">0</div>
        <div class="lbl">Sin emparejar</div>
      </div>
      <div class="summary-item">
        <div class="num" id="count-total">0</div>
        <div class="lbl">Total alumnos</div>
      </div>
    </div>
    <button class="btn btn-download hidden" id="btn-download" onclick="downloadZip()">
      ‚¨áÔ∏è Descargar PDFs protegidos (.zip)
    </button>
  </div>
</div>

<script>
  // Configurar PDF.js
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  let excelData = [];
  let pdfFiles = []; // { name, data, textContent, foundDni }
  let resultZip = null;
  let renameMode = 'nombre_dni';

  const btnProcess = document.getElementById('btn-process');

  // Rename options
  document.querySelectorAll('#rename-options .radio-option').forEach(opt => {
    opt.addEventListener('click', () => {
      document.querySelectorAll('#rename-options .radio-option').forEach(o => o.classList.remove('selected'));
      opt.classList.add('selected');
      renameMode = opt.dataset.value;
    });
  });

  // Drag & drop
  ['excel-zone', 'pdf-zone'].forEach(id => {
    const zone = document.getElementById(id);
    zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
    zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
    zone.addEventListener('drop', e => { e.preventDefault(); zone.classList.remove('dragover'); });
  });

  // === EXCEL ===
  document.getElementById('excel-input').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const infoEl = document.getElementById('excel-info');
    const colSelect = document.getElementById('column-select');

    try {
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data, { type: 'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, { defval: '' });

      if (json.length === 0) {
        alert('El archivo Excel est√° vac√≠o');
        return;
      }

      excelData = json;
      const cols = Object.keys(json[0]);

      // Populate selects
      const nameSelect = document.getElementById('col-name');
      const dniSelect = document.getElementById('col-dni');
      nameSelect.innerHTML = '';
      dniSelect.innerHTML = '';

      cols.forEach(col => {
        nameSelect.innerHTML += `<option value="${col}">${col}</option>`;
        dniSelect.innerHTML += `<option value="${col}">${col}</option>`;
      });

      // Auto-detect columns
      const lowerCols = cols.map(c => c.toLowerCase());
      const nameIdx = lowerCols.findIndex(c => c.includes('nombre') || c.includes('alumno') || c.includes('name'));
      const dniIdx = lowerCols.findIndex(c => c.includes('dni') || c.includes('documento') || c.includes('id'));
      
      if (nameIdx >= 0) nameSelect.selectedIndex = nameIdx;
      if (dniIdx >= 0) dniSelect.selectedIndex = dniIdx;

      infoEl.innerHTML = `<div class="file-info">‚úÖ ${file.name} ‚Äî ${json.length} alumnos encontrados</div>`;
      infoEl.classList.remove('hidden');
      colSelect.classList.remove('hidden');

      document.getElementById('step1-ind').classList.remove('active');
      document.getElementById('step1-ind').classList.add('done');
      document.getElementById('step2-ind').classList.add('active');

      updatePreview();
      checkReady();
    } catch (err) {
      alert('Error al leer el Excel: ' + err.message);
    }
  });

  document.getElementById('col-name').addEventListener('change', updatePreview);
  document.getElementById('col-dni').addEventListener('change', updatePreview);

  // === PDFs ===
  document.getElementById('pdf-input').addEventListener('change', async function(e) {
    const files = Array.from(e.target.files);
    if (files.length === 0) return;

    const loadingEl = document.getElementById('pdf-loading');
    const scanningEl = document.getElementById('pdf-scanning');
    const scanText = document.getElementById('scan-text');
    const infoEl = document.getElementById('pdf-info');

    pdfFiles = [];
    loadingEl.classList.remove('hidden');
    scanningEl.classList.add('hidden');
    infoEl.classList.add('hidden');

    // Check if ZIP
    if (files.length === 1 && files[0].name.toLowerCase().endsWith('.zip')) {
      try {
        const zipData = await files[0].arrayBuffer();
        const zip = await JSZip.loadAsync(zipData);
        const pdfEntries = Object.entries(zip.files).filter(
          ([name, entry]) => !entry.dir && name.toLowerCase().endsWith('.pdf')
        );

        for (const [name, entry] of pdfEntries) {
          const data = await entry.async('arraybuffer');
          const fileName = name.split('/').pop();
          pdfFiles.push({ name: fileName, data, textContent: '', foundDni: null });
        }
      } catch (err) {
        loadingEl.classList.add('hidden');
        alert('Error al leer el ZIP: ' + err.message);
        return;
      }
    } else {
      for (const file of files.filter(f => f.name.toLowerCase().endsWith('.pdf'))) {
        const data = await file.arrayBuffer();
        pdfFiles.push({ name: file.name, data, textContent: '', foundDni: null });
      }
    }

    loadingEl.classList.add('hidden');
    
    if (pdfFiles.length === 0) {
      alert('No se encontraron archivos PDF');
      return;
    }

    // Now scan PDF contents
    scanningEl.classList.remove('hidden');
    
    for (let i = 0; i < pdfFiles.length; i++) {
      scanText.textContent = `Escaneando PDF ${i + 1} de ${pdfFiles.length}...`;
      try {
        const text = await extractTextFromPDF(pdfFiles[i].data);
        pdfFiles[i].textContent = text;
        
        // Try to find a DNI in the text
        if (excelData.length > 0) {
          const dniCol = document.getElementById('col-dni').value;
          for (const row of excelData) {
            const dni = String(row[dniCol] || '').trim();
            if (dni && text.includes(dni)) {
              pdfFiles[i].foundDni = dni;
              break;
            }
          }
        }
      } catch (err) {
        console.warn('Error scanning PDF:', pdfFiles[i].name, err);
      }
      
      // Small delay to keep UI responsive
      if (i % 5 === 0) await new Promise(r => setTimeout(r, 10));
    }

    scanningEl.classList.add('hidden');
    
    const matchedCount = pdfFiles.filter(p => p.foundDni).length;
    infoEl.innerHTML = `<div class="file-info">‚úÖ ${pdfFiles.length} PDFs cargados ‚Äî ${matchedCount} con DNI identificado</div>`;
    infoEl.classList.remove('hidden');

    document.getElementById('step2-ind').classList.remove('active');
    document.getElementById('step2-ind').classList.add('done');
    document.getElementById('step3-ind').classList.add('active');
    
    document.getElementById('options-card').classList.remove('hidden');
    updatePreview();
    checkReady();
  });

  // Extract text from PDF using pdf.js
  async function extractTextFromPDF(arrayBuffer) {
    try {
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let fullText = '';
      
      // Read first 3 pages max (DNI should be there)
      const maxPages = Math.min(pdf.numPages, 3);
      
      for (let i = 1; i <= maxPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(item => item.str).join(' ');
        fullText += pageText + ' ';
      }
      
      return fullText;
    } catch (err) {
      console.warn('PDF text extraction failed:', err);
      return '';
    }
  }

  function findStudentByDni(dni) {
    if (!dni) return null;
    const dniCol = document.getElementById('col-dni').value;
    return excelData.find(row => String(row[dniCol] || '').trim() === dni);
  }

  function findPdfForStudent(studentDni) {
    return pdfFiles.find(pdf => pdf.foundDni === studentDni);
  }

  function updatePreview() {
    if (!excelData.length) return;
    
    const nameCol = document.getElementById('col-name').value;
    const dniCol = document.getElementById('col-dni').value;
    const container = document.getElementById('preview-container');
    const table = document.getElementById('preview-table');
    
    // Re-scan PDFs for DNIs with current column selection
    if (pdfFiles.length > 0) {
      for (const pdf of pdfFiles) {
        pdf.foundDni = null;
        for (const row of excelData) {
          const dni = String(row[dniCol] || '').trim();
          if (dni && pdf.textContent.includes(dni)) {
            pdf.foundDni = dni;
            break;
          }
        }
      }
    }
    
    const preview = excelData.slice(0, 8);
    let html = '<thead><tr><th>Alumno</th><th>DNI</th><th>PDF encontrado</th></tr></thead><tbody>';
    
    preview.forEach(row => {
      const name = String(row[nameCol] || '').trim();
      const dni = String(row[dniCol] || '').trim();
      const matchedPdf = findPdfForStudent(dni);
      
      let tag;
      if (pdfFiles.length === 0) {
        tag = '<span class="tag tag-pending">‚è≥ Sube los PDFs</span>';
      } else if (matchedPdf) {
        const shortName = matchedPdf.name.length > 30 ? matchedPdf.name.substring(0, 27) + '...' : matchedPdf.name;
        tag = `<span class="tag tag-ok">‚úì ${shortName}</span>`;
      } else {
        tag = `<span class="tag tag-no">‚úó DNI no encontrado en PDFs</span>`;
      }
      
      html += `<tr><td>${name}</td><td>${dni}</td><td>${tag}</td></tr>`;
    });
    
    if (excelData.length > 8) {
      html += `<tr><td colspan="3" style="color:var(--text2);text-align:center;font-family:'DM Sans',sans-serif;font-size:0.8rem;">... y ${excelData.length - 8} alumnos m√°s</td></tr>`;
    }
    
    html += '</tbody>';
    table.innerHTML = html;
    container.classList.remove('hidden');
  }

  function checkReady() {
    btnProcess.disabled = !(excelData.length > 0 && pdfFiles.length > 0);
  }

  // === PROCESS ===
  btnProcess.addEventListener('click', processAll);

  async function processAll() {
    const nameCol = document.getElementById('col-name').value;
    const dniCol = document.getElementById('col-dni').value;
    const log = document.getElementById('log');
    const results = document.getElementById('results');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    const summary = document.getElementById('summary');
    const btnDl = document.getElementById('btn-download');

    results.classList.remove('hidden');
    summary.classList.add('hidden');
    btnDl.classList.add('hidden');
    log.innerHTML = '';
    progressFill.style.width = '0%';
    progressText.textContent = '';
    btnProcess.disabled = true;
    btnProcess.innerHTML = '<span class="loading-spinner"></span> Procesando...';

    resultZip = new JSZip();
    let okCount = 0;
    let errCount = 0;
    const total = excelData.length;
    const usedPdfs = new Set();

    logMsg('info', `‚îÅ‚îÅ‚îÅ Iniciando proceso para ${total} alumnos ‚îÅ‚îÅ‚îÅ`);
    logMsg('info', `PDFs cargados: ${pdfFiles.length}`);
    logMsg('info', `Modo de renombrado: ${renameMode}`);
    logMsg('info', '');

    for (let i = 0; i < total; i++) {
      const row = excelData[i];
      const name = String(row[nameCol] || '').trim();
      const dni = String(row[dniCol] || '').trim();

      if (!name || !dni) {
        logMsg('warn', `‚ö† Fila ${i + 1}: nombre o DNI vac√≠o, saltando`);
        errCount++;
        updateProgress(i + 1, total, progressFill, progressText);
        continue;
      }

      // Find PDF by DNI in content
      const matchedPdf = findPdfForStudent(dni);

      if (!matchedPdf) {
        logMsg('err', `‚úó ${name} (DNI: ${dni}) ‚Äî No se encontr√≥ PDF con este DNI`);
        errCount++;
      } else {
        try {
          const pdfDoc = await PDFLib.PDFDocument.load(matchedPdf.data, { ignoreEncryption: true });
          
          const encrypted = await PDFLib.PDFDocument.create();
          const pages = await encrypted.copyPages(pdfDoc, pdfDoc.getPageIndices());
          pages.forEach(p => encrypted.addPage(p));
          
          const savedBytes = await encrypted.save({
            userPassword: dni,
            ownerPassword: dni,
            permissions: {
              printing: 'highQuality',
              modifying: false,
              copying: false,
            }
          });

          // Generate new filename based on rename mode
          const cleanName = name.replace(/[\\/:*?"<>|]/g, '_').trim();
          let newFileName;
          switch (renameMode) {
            case 'nombre_dni':
              newFileName = `${cleanName}_${dni}.pdf`;
              break;
            case 'dni_nombre':
              newFileName = `${dni}_${cleanName}.pdf`;
              break;
            case 'solo_nombre':
              newFileName = `${cleanName}.pdf`;
              break;
            default:
              newFileName = matchedPdf.name;
          }

          resultZip.file(newFileName, savedBytes);
          usedPdfs.add(matchedPdf.name);
          logMsg('ok', `‚úì ${name} ‚Üí ${newFileName} (üîë ${dni})`);
          okCount++;
        } catch (err) {
          logMsg('err', `‚úó ${name} ‚Äî error: ${err.message}`);
          errCount++;
        }
      }

      updateProgress(i + 1, total, progressFill, progressText);
      if (i % 3 === 0) await new Promise(r => setTimeout(r, 5));
    }

    // Report unmatched PDFs
    const unmatchedPdfs = pdfFiles.filter(f => !usedPdfs.has(f.name));
    if (unmatchedPdfs.length > 0) {
      logMsg('info', '');
      logMsg('warn', `‚ö† ${unmatchedPdfs.length} PDFs sin asignar:`);
      unmatchedPdfs.slice(0, 10).forEach(f => {
        const dniFound = f.foundDni ? `(contiene DNI: ${f.foundDni})` : '(sin DNI detectado)';
        logMsg('warn', `   üìÑ ${f.name} ${dniFound}`);
      });
      if (unmatchedPdfs.length > 10) {
        logMsg('warn', `   ... y ${unmatchedPdfs.length - 10} m√°s`);
      }
    }

    logMsg('info', '');
    logMsg('info', `‚îÅ‚îÅ‚îÅ Completado: ${okCount} protegidos, ${errCount} sin emparejar ‚îÅ‚îÅ‚îÅ`);

    document.getElementById('count-ok').textContent = okCount;
    document.getElementById('count-err').textContent = errCount;
    document.getElementById('count-total').textContent = total;
    summary.classList.remove('hidden');

    if (okCount > 0) btnDl.classList.remove('hidden');

    btnProcess.disabled = false;
    btnProcess.innerHTML = 'üîê Escanear PDFs y Proteger con Contrase√±a';
    document.getElementById('step3-ind').classList.remove('active');
    document.getElementById('step3-ind').classList.add('done');

    results.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  function updateProgress(current, total, fill, text) {
    const pct = Math.round((current / total) * 100);
    fill.style.width = pct + '%';
    text.textContent = `${current} de ${total} alumnos procesados (${pct}%)`;
  }

  function logMsg(type, msg) {
    const log = document.getElementById('log');
    log.innerHTML += `<div class="log-${type}">${msg}</div>`;
    log.scrollTop = log.scrollHeight;
  }

  async function downloadZip() {
    const btn = document.getElementById('btn-download');
    btn.innerHTML = '<span class="loading-spinner"></span> Generando ZIP...';
    btn.disabled = true;
    
    try {
      const blob = await resultZip.generateAsync({ type: 'blob' });
      saveAs(blob, 'PDFs_protegidos_renombrados.zip');
    } catch (err) {
      alert('Error al generar el ZIP: ' + err.message);
    }
    
    btn.innerHTML = '‚¨áÔ∏è Descargar PDFs protegidos (.zip)';
    btn.disabled = false;
  }
</script>

</body>
</html>
